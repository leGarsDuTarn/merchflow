<div class="container mt-4 mb-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to dashboard_path(year: @prev_year, month: @prev_month), class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-bold text-orange text-center m-0 text-capitalize">
      <%= I18n.l @target_date, format: "%B %Y" %>
    </h3>

    <% is_next_month_in_future = (@target_date + 1.month).beginning_of_month > Date.current.beginning_of_month %>
    <%= link_to dashboard_path(year: @next_year, month: @next_month), class: "btn btn-orange-outline rounded-3 #{'disabled' if is_next_month_in_future}" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>
  </div>

  <p class="text-center text-muted mb-5">
    Votre activité du mois en un coup d'œil.
  </p>


  <%# ========================================================== %>
  <%# NOTIFICATION D'OPPORTUNITÉS (MIS EN COMMENTAIRE POUR LE MVP V1) %>
  <%# ========================================================== %>
  <%# N'affiche QUE si c'est le mois en cours ET qu'il y a des propositions %>
  <%# if @is_current_month && @pending_proposals_count.to_i > 0 %>
    <%# <div class="row mb-4 animate__animated animate__fadeIn">
      <%# div %> <%# class="col-12"> %>
        <%# div %> <%# class="card shadow-sm p-4 rounded-4 text-center border border-orange position-relative" style="background-color: #fff;"> %>

          <%# <div %> <%# class="d-flex justify-content-center align-items-center flex-column flex-md-row"> %>
            <%# div %> <%# class="me-md-4 mb-3 mb-md-0"> %>
             <%#  <span %> <%# class="display-6 fw-bold text-orange"> %>
                <%#= @pending_proposals_count %>
             <%#  </span> %>
            <%# /div> %>
            <%# <div class="text-md-start"> %>
              <%# <h5 class="fw-bold text-dark mb-1"> %>
                <%# Nouvelle %><%#= 's' if @pending_proposals_count > 1 %> <%# opportunité %><%#= 's' if @pending_proposals_count > 1 %> <%# ! %>
              <%# </h5> %>
              <%# <p class="text-muted mb-2 small"> %>
                <%# Vous avez reçu des propositions de mission qui attendent votre réponse. %>
             <%#  </p> %>
              <%#= link_to merch_proposals_path, class: "btn btn-orange btn-sm fw-bold px-4 rounded-pill" do %>
               <%#  Voir les propositions %> <%# <i class="fa-solid fa-arrow-right ms-2"></i> %>
              <%# end %>
            <%# /div> %>
          <%# </div> %>

          <%# <div data-controller="vibration" data-vibration-count-value=" %><%#= @pending_proposals_count.to_i %><%# "></div> %>
       <%#  </div> %>
     <%#  </div> %>
    <%# </div> %>
  <%# end %>


  <div class="row g-4">
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Heures</h5>
        <p class="display-6 fw-bold mt-2">
          <%= @total_hours_month.to_i %> h
        </p>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Brut</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(@total_brut_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Kilomètres</h5>
        <p class="display-6 fw-bold mt-2">
          <%= @km_month.to_i %> km
        </p>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-4">
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Frais km remboursés</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(@km_payment_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Net estimé</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(@net_estimated_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Net total estimé (km inclus)</h5>
        <p class="display-6 fw-bold mt-2 text-orange">
          <%= number_to_currency(@net_total_estimated_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-4">
    <div class="col-12">
      <div class="card shadow-sm p-4 rounded-4">
        <h5 class="fw-bold text-orange mb-3 text-center">
          Répartition par agence (<%= I18n.l @target_date, format: "%B" %>)
        </h5>

        <% if @by_agency.any? %>
          <div class="table-responsive">
            <table class="table table-borderless align-middle mb-0">
              <thead>
                <tr class="text-muted">
                  <th>Agence</th>
                  <th>Heures</th>
                  <th>Brut</th>
                  <th>Km</th>
                </tr>
              </thead>
              <tbody>
                <% @by_agency.each do |stats| %>
                  <tr>
                    <td><strong><%= stats[:agency] %></strong></td>
                    <td><%= stats[:hours] %> h</td>
                    <td><%= number_to_currency(stats[:brut], unit: "€", format: "%n %u") %></td>
                    <td><%= stats[:km].to_i %> km</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-center text-muted m-0">
            Aucune donnée disponible pour ce mois.
          </p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="text-center mt-5">
    <%= link_to "Créer un contrat", new_contract_path, class: "btn btn-orange btn-lg fw-bold px-4 me-3" %>

    <% if current_user.contracts.exists? %>
      <%= link_to "Créer une mission", new_contract_work_session_path(current_user.contracts.first), class: "btn btn-orange-outline btn-lg fw-bold px-4 mt-2 m-2" %>
    <% else %>
      <button class="btn btn-orange-outline btn-lg fw-bold mt-2 px-4" disabled>Créer une mission</button>
      <p class="text-muted mt-2 small">Vous devez d’abord créer un contrat.</p>
    <% end %>
  </div>
</div>

