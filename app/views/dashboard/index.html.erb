<div class="container mt-4 mb-5">

  <!-- TITRE -->
  <h1 class="fw-bold text-orange text-center mb-4">
    Tableau de bord
  </h1>

  <p class="text-center text-muted mb-5">
    Votre activité du mois en un coup d'œil.
  </p>

  <!-- LIGNE 1 : Heures / Brut / KM -->
  <div class="row g-4">

    <!-- Heures -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Heures</h5>
        <p class="display-6 fw-bold mt-2">
          <%= current_user.total_hours_this_month %> h
        </p>
      </div>
    </div>

    <!-- Brut -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Brut</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(current_user.total_brut_this_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <!-- Kilomètres -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Kilomètres</h5>
        <p class="display-6 fw-bold mt-2">
          <%= current_user.total_km_this_month.to_i %> km
        </p>
      </div>
    </div>

  </div>

  <!-- LIGNE 2 : Frais km / Net estimé / Net total estimé -->
  <div class="row g-4 mt-4">

    <!-- Frais km remboursés -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Frais km remboursés</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(current_user.total_km_payment_this_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <!-- Net estimé (ORANGE) -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Net estimé</h5>
        <p class="display-6 fw-bold mt-2">
          <%= number_to_currency(current_user.net_estimated_this_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

    <!-- Net total estimé (ORANGE) -->
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm p-4 rounded-4 text-center h-100">
        <h5 class="text-muted mb-0">Net total estimé (km inclus)</h5>
        <p class="display-6 fw-bold mt-2 text-orange">
          <%= number_to_currency(current_user.net_total_estimated_this_month, unit: "€", format: "%n %u") %>
        </p>
      </div>
    </div>

  </div>

  <!-- LIGNE 3 : Répartition par agence -->
  <div class="row g-4 mt-4">
    <div class="col-12">
      <div class="card shadow-sm p-4 rounded-4">

        <h5 class="fw-bold text-orange mb-3 text-center">
          Répartition par agence (mois)
        </h5>

        <% if current_user.total_by_agency_this_month.any? %>
          <div class="table-responsive">
            <table class="table table-borderless align-middle mb-0">
              <thead>
                <tr class="text-muted">
                  <th>Agence</th>
                  <th>Heures</th>
                  <th>Brut</th>
                  <th>Km</th>
                </tr>
              </thead>
              <tbody>
                <% current_user.total_by_agency_this_month.each do |stats| %>
                  <tr>
                    <td><strong><%= stats[:agency] %></strong></td>
                    <td><%= stats[:hours] %> h</td>
                    <td><%= number_to_currency(stats[:brut], unit: "€", format: "%n %u") %></td>
                    <td><%= stats[:km].to_i %> km</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-center text-muted m-0">
            Aucune donnée disponible pour ce mois.
          </p>
        <% end %>

      </div>
    </div>
  </div>

  <!-- ============================
     CONFIDENTIALITÉ TURBO FRAME
     ============================ -->
<turbo-frame id="privacy_settings">
  <div class="card shadow-sm rounded-4 p-4 mt-5"
       data-controller="auto-save">

    <h5 class="fw-bold text-orange mb-3 text-center">
      Confidentialité de vos informations
    </h5>

    <p class="text-muted small text-center mb-4">
      Contrôlez ce que les forces de vente peuvent voir.
    </p>

    <!-- FLASH inline -->
    <div data-auto-save-target="flash"
         class="alert alert-success py-1 px-2 text-center small d-none"
         style="border-radius: 6px;">
      Enregistré ✓
    </div>

    <%= form_with model: current_user,
                  url: "/dashboard/privacy",
                  method: :patch,
                  data: { action: "turbo:submit-end->auto-save#showFlash" } do |f| %>

      <div class="d-flex flex-column gap-3">

        <!-- Identité -->
        <div class="d-flex justify-content-between align-items-center">
          <label class="fw-semibold">Afficher mon identité</label>
          <div class="form-check form-switch m-0">
            <%= f.check_box :allow_identity,
                class: "form-check-input",
                checked: current_user.allow_identity,
                data: { action: "change->auto-save#submit" } %>
          </div>
        </div>

        <!-- Email -->
        <div class="d-flex justify-content-between align-items-center">
          <label class="fw-semibold">Partager mon email</label>
          <div class="form-check form-switch m-0">
            <%= f.check_box :allow_email,
                class: "form-check-input",
                checked: current_user.allow_email,
                data: { action: "change->auto-save#submit" } %>
          </div>
        </div>

        <!-- Téléphone -->
        <div class="d-flex justify-content-between align-items-center">
          <label class="fw-semibold">Partager mon téléphone</label>
          <div class="form-check form-switch m-0">
            <%= f.check_box :allow_phone,
                class: "form-check-input",
                checked: current_user.allow_phone,
                data: { action: "change->auto-save#submit" } %>
          </div>
        </div>

      </div>

    <% end %>

  </div>
</turbo-frame>


  <!-- BOUTONS ACTION -->
  <div class="text-center mt-5">

    <%= link_to "Créer un contrat",
                new_contract_path,
                class: "btn btn-orange btn-lg fw-bold px-4 me-3" %>

    <% if current_user.contracts.exists? %>
      <%= link_to "Créer une mission",
                  new_contract_work_session_path(current_user.contracts.first),
                  class: "btn btn-orange-outline btn-lg fw-bold px-4 mt-2 m-2" %>
    <% else %>
      <button class="btn btn-orange-outline btn-lg fw-bold mt-2 px-4" disabled>
        Créer une mission
      </button>
      <p class="text-muted mt-2 small">
        Vous devez d’abord créer un contrat.
      </p>
    <% end %>

  </div>

</div>

<footer class="text-center text-muted mt-4">
  <small>© <%= Time.current.year %> MerchFlow — Votre assistant administratif merch.</small>
</footer>
