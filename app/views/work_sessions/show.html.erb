<div class="container my-5">

  <!-- Titre + bouton retour -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-orange m-0">
      Mission du <%= l @work_session.date, format: :long %>
    </h1>

    <%= link_to contract_path(@work_session.contract),
                class: "btn btn-orange fw-semibold" do %>
      <i class="fa-solid fa-arrow-left"></i>
    <% end %>
  </div>

  <div class="card shadow-sm rounded-4 p-4">

    <!-- Infos principales -->
    <h4 class="fw-bold text-orange mb-3">
      <i class="fa-solid fa-store me-2"></i>
      <%= @work_session.store.presence || "Magasin non renseigné" %>
    </h4>

    <% if @work_session.store_full_address.present? %>
      <p class="text-muted mb-3">
        <i class="fa-solid fa-location-dot me-1"></i>
        <%= @work_session.store_full_address %>
      </p>
    <% end %>

    <hr>

    <!-- Horaires -->
    <h5 class="fw-semibold mb-2"><i class="fa-solid fa-clock me-2"></i>Horaires</h5>
    <div class="bg-light rounded-3 p-3 mb-3">
      <p class="mb-1"><strong>Début :</strong> <%= l @work_session.start_time, format: :short %></p>
      <p class="mb-1"><strong>Fin :</strong>   <%= l @work_session.end_time, format: :short %></p>

      <p class="mb-1">
        <strong>Durée totale :</strong>
        <%= (@work_session.duration_minutes.to_f / 60).round(2) %> h
      </p>

      <p class="mb-0">
        <strong>Temps de nuit :</strong>
        <%= (@work_session.night_minutes.to_f / 60).round(2) %> h
      </p>
    </div>

    <!-- DÉTAIL CALCUL NUIT -->
    <h5 class="fw-semibold mb-2">
      <i class="fa-solid fa-moon me-2"></i>Détail du calcul de nuit
    </h5>

    <% if @work_session.night_minutes > 0 %>
      <% h_day   = (@work_session.duration_minutes - @work_session.night_minutes) / 60.0 %>
      <% h_night = @work_session.night_minutes / 60.0 %>
      <% night_rate = @work_session.contract.night_rate %>
      <% night_hourly = @work_session.hourly_rate * (1 + night_rate) %>

      <div class="bg-light rounded-3 p-3 mb-3">
        <p class="mb-1"><strong>Heures de jour :</strong>
          <%= h_day.round(2) %> h × <%= number_to_currency(@work_session.hourly_rate) %>
        </p>

        <p class="mb-1"><strong>Heures de nuit :</strong>
          <%= h_night.round(2) %> h × <%= number_to_currency(night_hourly) %>
        </p>

        <p class="mb-0 fw-bold">
          <strong>Majoration nuit :</strong> +<%= (night_rate * 100).round(1) %>%
        </p>
      </div>
    <% else %>
      <div class="bg-light rounded-3 p-3 mb-3">
        <p class="text-muted mb-0">Aucune heure de nuit effectuée.</p>
      </div>
    <% end %>

    <!-- KM -->
    <h5 class="fw-semibold mb-2"><i class="fa-solid fa-road me-2"></i>Déplacements</h5>
    <div class="bg-light rounded-3 p-3 mb-3">
      <p class="mb-1"><strong>Kilomètres comptés :</strong> <%= @work_session.effective_km %> km</p>
      <p class="mb-0"><strong>Indemnités km :</strong>
        <%= number_to_currency(@work_session.km_payment_final, unit: "€") %>
      </p>
    </div>

    <!-- Paiements BRUT -->
    <h5 class="fw-semibold mb-2"><i class="fa-solid fa-euro-sign me-2"></i>Rémunération (Brut)</h5>
    <div class="bg-light rounded-3 p-3 mb-3">
      <p class="mb-1"><strong>Brut mission :</strong>
        <%= number_to_currency(@work_session.brut, unit: "€") %>
      </p>

      <% brut = @work_session.brut %>
      <% ifm_brut = @work_session.contract.ifm(brut).round(2) %>
      <% cp_brut  = @work_session.contract.cp(brut).round(2) %>

      <p class="mb-1"><strong>IFM (brut) :</strong> <%= number_to_currency(ifm_brut) %></p>
      <p class="mb-1"><strong>CP (brut) :</strong> <%= number_to_currency(cp_brut) %></p>

      <p class="mb-0 fw-bold text-orange">
        Total brut : <%= number_to_currency(brut + ifm_brut + cp_brut) %>
      </p>
    </div>

    <!-- Paiement NET estimé -->
    <% net_estime = @work_session.net %>
    <% ifm_net = (ifm_brut * 0.78).round(2) %>
    <% cp_net  = (cp_brut  * 0.78).round(2) %>
    <% km_net  = @work_session.km_payment_final %>
    <% sous_total_net = (net_estime + ifm_net + cp_net).round(2) %>
    <% total_net = (sous_total_net + km_net).round(2) %>

    <h5 class="fw-semibold mb-2"><i class="fa-solid fa-wallet me-2"></i>Rémunération (Net estimé)</h5>
    <div class="bg-light rounded-3 p-3 mb-3">

      <p class="mb-1"><strong>Net mission :</strong>
        <%= number_to_currency(net_estime) %>
      </p>

      <p class="mb-1"><strong>IFM (net estimé) :</strong>
        <%= number_to_currency(ifm_net) %>
      </p>

      <p class="mb-1"><strong>CP (net estimé) :</strong>
        <%= number_to_currency(cp_net) %>
      </p>

      <hr>

      <p class="mb-1 fw-bold">Sous-total net (mission + IFM + CP) :
        <%= number_to_currency(sous_total_net) %>
      </p>

      <p class="mb-1"><strong>KM (non imposable) :</strong>
        <%= number_to_currency(km_net) %>
      </p>

      <p class="mb-0 fw-bold text-orange fs-5">
        TOTAL NET estimé : <%= number_to_currency(total_net) %>
      </p>
    </div>

    <!-- Notes -->
    <% if @work_session.notes.present? %>
      <h5 class="fw-semibold mb-2"><i class="fa-solid fa-note-sticky me-2"></i>Notes</h5>
      <div class="bg-light rounded-3 p-3 mb-3">
        <%= simple_format(@work_session.notes) %>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="d-flex justify-content-between mt-4">
      <%= link_to edit_work_session_path(@work_session),
                  class: "btn btn-orange fw-semibold" do %>
        <i class="fa-solid fa-pen-to-square me-2"></i> Modifier
      <% end %>

      <%= link_to work_session_path(@work_session),
                  data: { turbo_method: :delete, turbo_confirm: "Supprimer cette mission ?" },
                  class: "btn btn-orange fw-semibold" do %>
        <i class="fa-solid fa-trash me-2"></i> Supprimer
      <% end %>
    </div>

  </div>
</div>

<footer class="text-center text-muted my-3">
  <small>© <%= Time.current.year %> MerchFlow — Votre assistant administratif merch.</small>
</footer>
