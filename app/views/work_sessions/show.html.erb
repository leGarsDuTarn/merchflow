<div class="container my-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="fw-bold text-dark m-0">Détail de la mission</h1>
      <p class="text-muted mb-0">
        <%= l @work_session.date, format: :long %>
      </p>
    </div>

    <%= link_to contract_path(@work_session.contract),
                class: "btn btn-light shadow-sm text-muted border rounded-circle p-3",
                style: "width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;" do %>
      <i class="fa-solid fa-arrow-left"></i>
    <% end %>
  </div>

  <div class="row g-4">

    <div class="col-lg-5">

      <div class="card shadow border-0 rounded-4 mb-4 h-100 position-relative overflow-hidden">

        <% if @work_session.recommended %>
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge bg-orange text-white rounded-pill px-2 py-1 shadow-sm small">
              <i class="fa-solid fa-star"></i> Recommandé
            </span>
          </div>
        <% end %>
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-4">
            <div class="bg-orange-light text-orange rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
              <i class="fa-solid fa-store fs-4"></i>
            </div>
            <div>
              <h5 class="fw-bold mb-0 text-dark"><%= @work_session.store.presence || "Magasin inconnu" %></h5>
              <small class="text-muted"><%= @work_session.company %></small>
            </div>
          </div>

          <% if @work_session.store_full_address.present? %>
            <div class="d-flex align-items-start mb-3">
              <i class="fa-solid fa-location-dot text-orange mt-1 me-2"></i>
              <span class="text-muted small"><%= @work_session.store_full_address %></span>
            </div>
          <% end %>

          <hr class="text-muted opacity-25">

          <div class="row g-2 text-center">
            <div class="col-6">
              <div class="bg-light rounded-3 p-2">
                <small class="text-muted d-block">Début</small>
                <span class="fw-bold"><%= l @work_session.start_time, format: :short %></span>
              </div>
            </div>
            <div class="col-6">
              <div class="bg-light rounded-3 p-2">
                <small class="text-muted d-block">Fin</small>
                <span class="fw-bold"><%= l @work_session.end_time, format: :short %></span>
              </div>
            </div>
          </div>

          <div class="row g-2 mt-1 text-center">
            <div class="col-6">
              <div class="border border-orange-subtle bg-orange-light rounded-3 p-3">
                <i class="fa-regular fa-clock text-orange mb-1"></i>
                <div class="fw-bold text-dark">
                  <%= (@work_session.duration_minutes.to_f / 60).round(2) %> h
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Durée totale</small>
              </div>
            </div>
            <div class="col-6">
              <div class="border border-orange-subtle bg-orange-light rounded-3 p-3">
                <i class="fa-solid fa-road text-orange mb-1"></i>
                <div class="fw-bold text-dark">
                  <%= @work_session.effective_km %> km
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Déplacements</small>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col-lg-7">

      <div class="card shadow border-0 rounded-4 h-100">
        <div class="card-body p-4">
          <h5 class="fw-bold text-orange mb-4">Détail de la rémunération</h5>

          <%
             # Récupération des données
             brut      = @work_session.brut
             ifm_brut  = @work_session.amount_ifm
             cp_brut   = @work_session.amount_cp

             total_brut = brut + ifm_brut + cp_brut

             net_estime = @work_session.net
             ifm_net    = (ifm_brut * 0.78).round(2)
             cp_net     = (cp_brut  * 0.78).round(2)
             km_net     = @work_session.km_payment_final

             sous_total_net = (net_estime + ifm_net + cp_net).round(2)
             total_net      = (sous_total_net + km_net).round(2)
          %>

          <% if @work_session.night_minutes > 0 %>
            <div class="alert alert-dark d-flex align-items-center py-2 px-3 mb-4 rounded-3" role="alert">
              <i class="fa-solid fa-moon me-2"></i>
              <small class="mb-0">
                Dont <strong><%= (@work_session.night_minutes / 60.0).round(2) %>h de nuit</strong>
                (Majoration : +<%= (@work_session.contract.night_rate * 100).to_i %>%)
              </small>
            </div>
          <% end %>

          <div class="table-responsive mb-4">
            <table class="table table-borderless align-middle">
              <thead class="text-muted small border-bottom">
                <tr>
                  <th scope="col" class="fw-normal pb-2">Intitulé</th>
                  <th scope="col" class="fw-normal text-end pb-2">Brut</th>
                  <th scope="col" class="fw-normal text-end pb-2 text-orange">Net (est.)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="py-2">Salaire de base</td>
                  <td class="text-end text-muted"><%= number_to_currency(brut) %></td>
                  <td class="text-end fw-semibold"><%= number_to_currency(net_estime) %></td>
                </tr>
                <tr>
                  <td class="py-2">Indemnités </td>
                  <td class="text-end text-muted"><%= number_to_currency(ifm_brut) %></td>
                  <td class="text-end fw-semibold"><%= number_to_currency(ifm_net) %></td>
                </tr>
                <tr>
                  <td class="py-2">Congés Payés </td>
                  <td class="text-end text-muted"><%= number_to_currency(cp_brut) %></td>
                  <td class="text-end fw-semibold"><%= number_to_currency(cp_net) %></td>
                </tr>
                <tr class="border-top">
                  <td class="pt-3 fw-bold text-muted">Sous-total</td>
                  <td class="pt-3 text-end fw-bold text-muted"><%= number_to_currency(total_brut) %></td>
                  <td class="pt-3 text-end fw-bold"><%= number_to_currency(sous_total_net) %></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="bg-orange text-white rounded-4 p-4 position-relative overflow-hidden">
            <div class="position-absolute bg-white opacity-10 rounded-circle" style="width: 150px; height: 150px; top: -50px; right: -30px;"></div>

            <div class="d-flex justify-content-between align-items-center mb-2 position-relative">
              <span class="opacity-75">Sous-total Net</span>
              <span class="text-muted fw-semibold"><%= number_to_currency(sous_total_net) %></span>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3 position-relative border-bottom border-white border-opacity-25 pb-3">
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-gas-pump me-2 opacity-75"></i>
                <span class="opacity-75">Indemnités KM</span>
              </div>
              <span class="text-muted fw-semibold">+ <%= number_to_currency(km_net) %></span>
            </div>

            <div class="d-flex justify-content-between align-items-end position-relative">
              <div>
                <h2 class="fw-bold mb-0 display-6">Total Net</h2>
                <small class="opacity-75">Virement estimé</small>
              </div>
              <h2 class="fw-bold mb-0 display-6"><%= number_to_currency(total_net) %></h2>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <% if @work_session.notes.present? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card shadow-sm border-0 rounded-4 bg-light">
          <div class="card-body p-4">
            <h6 class="fw-bold text-muted mb-2"><i class="fa-solid fa-note-sticky me-2"></i>Notes personnelles</h6>
            <p class="mb-0 text-dark"><%= simple_format(@work_session.notes) %></p>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="d-flex justify-content-center gap-3 mt-5">
    <%= link_to edit_work_session_path(@work_session),
              class: "btn btn-orange rounded-pill px-4 fw-semibold" do %>
      <i class="fa-solid fa-pen me-2"></i>Modifier
    <% end %>

    <%= link_to work_session_path(@work_session),
              data: { turbo_method: :delete, turbo_confirm: "Êtes-vous sûr de vouloir supprimer cette mission ?" },
              class: "btn btn-red rounded-pill px-4 fw-semibold" do %>
      <i class="fa-solid fa-trash me-2"></i>Supprimer
    <% end %>
  </div>

</div>
