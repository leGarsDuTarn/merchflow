<div class="container my-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-orange m-0">
      Modifier la mission du <%= l @work_session.date, format: :long %>
    </h1>

    <%= link_to work_session_path(@work_session),
                class: "btn btn-orange-outline fw-semibold" do %>
      <i class="fa-solid fa-arrow-left me-2"></i> Retour
    <% end %>
  </div>

  <div class="card shadow-sm rounded-4 p-4">

    <%= form_with model: @work_session, local: true, html: { data: { turbo: false, controller: "break" } } do |f| %>

      <%# Entreprise %>
      <div class="mb-3">
            <%= f.label :company, "Entreprise", class: "form-label fw-semibold" %>
            <%= f.text_field :company,
            class: "form-control",
            placeholder: "Ex : Lindt, Bonduelle, PepsiCo" %>
      </div>

      <%# DATE %>
      <div class="mb-3">
        <%= f.label :date, "Date de la mission", class: "form-label fw-semibold" %>
        <%= f.date_field :date, class: "form-control" %>
        <%= inline_error_for(@work_session, :date) %>
      </div>

      <%# HORAIRES %>
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :start_time, "Début", class: "form-label fw-semibold" %>
          <%= f.time_field :start_time, class: "form-control" %>
          <%= inline_error_for(@work_session, :start_time) %>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label :end_time, "Fin", class: "form-label fw-semibold" %>
          <%= f.time_field :end_time, class: "form-control" %>
          <%= inline_error_for(@work_session, :end_time) %>
        </div>
      </div>

      <%# SECTION COUPURE (BREAK) %>
      <div class="mb-4 bg-light p-3 rounded-4 border">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleBreak"
                 data-action="change->break#toggle"
                 <%= 'checked' if @work_session.has_break? %>>
          <label class="form-check-label fw-bold text-dark" for="toggleBreak">
            <i class="fa-solid fa-mug-hot me-2 text-orange"></i>Coupure (pause non payée)
          </label>
        </div>

        <div id="break-inputs"
             data-break-target="fields"
             class="mt-3 <%= 'd-none' unless @work_session.has_break? %>">
          <div class="row">
            <div class="col-6">
              <%= f.label :break_start_time, "Début pause", class: "small fw-semibold text-muted" %>
              <%= f.time_field :break_start_time, class: "form-control form-control-sm" %>
            </div>
            <div class="col-6">
              <%= f.label :break_end_time, "Fin pause", class: "small fw-semibold text-muted" %>
              <%= f.time_field :break_end_time, class: "form-control form-control-sm" %>
            </div>
          </div>
          <div class="mt-2 text-orange" style="font-size: 0.75rem;">
            <i class="fa-solid fa-info-circle"></i> Cette période sera déduite du temps payé.
          </div>
        </div>
      </div>

      <%# TAUX HORAIRE %>
      <div class="mb-3">
        <%= f.label :hourly_rate, "Taux horaire (€)", class: "form-label fw-semibold" %>
        <%= f.number_field :hourly_rate, step: 0.01, class: "form-control" %>
        <small class="text-muted">Par défaut : SMIC (11.88€)</small>
        <%= inline_error_for(@work_session, :hourly_rate) %>
      </div>

      <%# MAGASIN %>
      <div class="mb-3">
        <%= f.label :store, "Nom du magasin", class: "form-label fw-semibold" %>
        <%= f.text_field :store, class: "form-control", placeholder: "Ex. Intermarché Carmaux" %>
        <%= inline_error_for(@work_session, :store) %>
      </div>

      <div class="mb-3">
        <%= f.label :store_full_address, "Adresse complète du magasin", class: "form-label fw-semibold" %>
        <%= f.text_field :store_full_address,
                         class: "form-control",
                         placeholder: "Ex. Bd Flandres, 81400 Carmaux" %>
        <%= inline_error_for(@work_session, :store_full_address) %>
      </div>

      <%# KM CUSTOM %>
      <div class="mb-3">
        <%= f.label :km_custom, "Kilomètres", class: "form-label fw-semibold" %>
        <%= f.number_field :km_custom, step: 0.1, class: "form-control" %>
        <%= inline_error_for(@work_session, :km_custom) %>
      </div>

      <%# === NOUVEAU BLOC : FRAIS ANNEXES === %>
      <div class="mb-4 bg-light p-3 rounded-4 border">
        <label class="form-label fw-bold text-dark mb-3">
          <i class="fa-solid fa-receipt me-2 text-orange"></i>Frais annexes (Déclaratif)
        </label>

        <div class="row g-2">
          <div class="col-4">
             <%= f.label :fee_meal, "Repas (€)", class: "small fw-semibold text-muted" %>
             <%= f.number_field :fee_meal, step: 0.01, class: "form-control", placeholder: "0.00" %>
          </div>
          <div class="col-4">
             <%= f.label :fee_parking, "Parking (€)", class: "small fw-semibold text-muted" %>
             <%= f.number_field :fee_parking, step: 0.01, class: "form-control", placeholder: "0.00" %>
          </div>
          <div class="col-4">
             <%= f.label :fee_toll, "Péage (€)", class: "small fw-semibold text-muted" %>
             <%= f.number_field :fee_toll, step: 0.01, class: "form-control", placeholder: "0.00" %>
          </div>
        </div>
        <div class="mt-2 text-muted fst-italic" style="font-size: 0.75rem;">
          Ces frais seront ajoutés au total net estimé.
        </div>
      </div>
      <%# ==================================== %>

      <%# RECOMMENDED %>
      <div class="form-check form-switch mb-3">
        <%= f.check_box :recommended, class: "form-check-input" %>
        <%= f.label :recommended, "Êtes-vous recommandé pour cette mission ?", class: "form-check-label fw-semibold" %>
      </div>

      <%# NOTES %>
      <div class="mb-3">
        <%= f.label :notes, "Notes", class: "form-label fw-semibold" %>
        <%= f.text_area :notes, rows: 3, class: "form-control",
                         placeholder: "Détails ou instructions…" %>
        <%= inline_error_for(@work_session, :notes) %>
      </div>

      <%# SUBMIT %>
      <div class="d-grid mt-3">
        <%= f.submit "Mettre à jour", class: "btn btn-orange btn-lg fw-bold" %>
      </div>

    <% end %>

  </div>

  <div class="text-center mt-3">
    <%= link_to "Retour", work_session_path(@work_session),
                class: "text-decoration-none text-muted" %>
  </div>

</div>
