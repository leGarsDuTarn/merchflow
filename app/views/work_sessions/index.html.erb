<div class="container my-4">

  <!-- ===== HEADER : Titre + Recherche + Bouton ===== -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">

    <!-- Titre -->
    <h1 class="fw-bold text-orange m-0 text-center text-md-start">
      Mes missions
    </h1>

    <!-- SEARCH + BUTTONS WRAPPER -->
    <div class="d-flex align-items-center gap-2 flex-md-row flex-column">

      <%= form_with url: work_sessions_path,
                    method: :get,
                    class: "d-flex align-items-center gap-2",
                    data: {
                      controller: "search",
                      "search-url-value": work_sessions_path
                    },
                    local: true do |f| %>

        <!-- Champ de recherche -->
        <div class="position-relative search-wrapper" style="max-width: 220px; width: 100%;">
          <%= f.text_field :query,
                value: @query,
                placeholder: "Rechercher…",
                class: "form-control pe-5",
                data: {
                  action: "input->search#search",
                  "search-target": "input"
                } %>

          <!-- Clear -->
          <span data-action="click->search#clear"
                data-search-target="clearButton"
                class="position-absolute top-50 end-0 translate-middle-y me-2"
                style="cursor:pointer; display:none;">
            <i class="fa-solid fa-xmark text-muted"></i>
          </span>
        </div>

        <!-- Bouton recherche -->
        <button class="btn btn-orange d-flex justify-content-center align-items-center"
                style="width:42px; height:42px;">
          <i class="fa-solid fa-search"></i>
        </button>

      <% end %>

      <!-- Bouton ajouter mission (conditionnel) -->
      <% if current_user.contracts.any? %>
        <%= link_to new_work_session_path,
                    class: "btn btn-orange d-flex justify-content-center align-items-center",
                    style: "width: 42px; height: 42px;",
                    title: "Ajouter une mission" do %>
          <i class="fa-solid fa-plus"></i>
        <% end %>
      <% else %>
        <button class="btn btn-secondary d-flex justify-content-center align-items-center"
                style="width: 42px; height: 42px;"
                title="Créez d'abord un contrat"
                disabled>
          <i class="fa-solid fa-plus"></i>
        </button>
      <% end %>

    </div>
  </div>


  <!-- Turbo Frame -->


    <% if @work_sessions.empty? %>

      <!-- ===== AUCUNE MISSION ===== -->
      <div class="text-center text-muted mt-5">
        <i class="fa-solid fa-circle-plus fa-3x mb-3 text-orange"></i>
        <h4 class="fw-semibold">Aucune mission enregistrée</h4>

        <% if current_user.contracts.any? %>
          <p class="mb-3">Créez votre première mission depuis un contrat ou depuis ici.</p>
          <%= link_to "Nouvelle mission",
                      new_work_session_path,
                      class: "btn btn-orange btn-lg fw-bold" %>
        <% else %>
          <p class="mb-3">Vous devez d'abord créer un contrat avant de pouvoir enregistrer une mission.</p>
          <%= link_to "Créer un contrat",
                      new_contract_path,
                      class: "btn btn-orange btn-lg fw-bold" %>
        <% end %>
      </div>

    <% else %>

      <!-- ===== LISTE DES MISSIONS ===== -->
      <div class="row g-3 g-md-4">

        <% @work_sessions.each do |ws| %>
          <div class="col-12 col-sm-6 col-lg-4">

            <div class="card shadow-sm rounded-4 p-3 h-100 d-flex flex-column">

              <!-- Date -->
              <h5 class="fw-bold text-orange mb-2">
                <i class="fa-solid fa-calendar-day me-2"></i>
                <%= l ws.date, format: :long %>
              </h5>

              <!-- Magasin -->
              <p class="text-muted small mb-1">
                <i class="fa-solid fa-store me-1"></i>
                <%= ws.store.presence || "Magasin non renseigné" %>
              </p>

              <!-- Contrat -->
              <p class="text-muted small mb-3">
                <i class="fa-solid fa-file-contract me-1"></i>
                <%= ws.contract.agency_label %> — <%= ws.company.presence || "Entreprise non renseignée" %>
              </p>

              <!-- Bloc infos -->
              <div class="bg-light p-3 rounded-3 small mb-3">
                <p class="mb-1"><strong>Heures :</strong> <%= (ws.duration_minutes.to_f / 60).round(2) %> h</p>
                <p class="mb-1"><strong>KM :</strong> <%= ws.effective_km %> km</p>
                <p class="mb-0 fw-bold text-orange">Total : <%= number_to_currency(ws.total_payment) %></p>
              </div>

              <!-- Actions -->
              <div class="d-flex justify-content-around mt-auto">

                <%= link_to work_session_path(ws),
                  class: "btn btn-orange btn-square",
                  data: { turbo: false },
                  title: "Voir" do %>
                  <i class="fa-solid fa-eye"></i>
                <% end %>

                <%= link_to edit_work_session_path(ws),
                  class: "btn btn-orange btn-square",
                  data: { turbo: false },
                  title: "Modifier" do %>
                  <i class="fa-solid fa-pen-to-square"></i>
                <% end %>

                <%= link_to work_session_path(ws),
                  class: "btn btn-orange btn-square",
                  data: {
                    turbo_method: :delete,
                    turbo_confirm: "Supprimer cette mission ?"
                  },
                  title: "Supprimer" do %>
                  <i class="fa-solid fa-trash-can"></i>
                <% end %>

            </div>

            </div>
          </div>
        <% end %>

      </div>

      <!-- Pagination -->
      <div class="mt-4">
        <%= render "shared/nav", pagy: @pagy %>
      </div>

    <% end %>
</div>
