<div class="container my-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-orange">
      <i class="fa-solid fa-paper-plane me-2"></i> Suivi des Propositions
    </h1>
    <%= link_to fve_merch_index_path, class: "btn btn-orange fw-semibold" do %>
      <i class="fa-solid fa-plus me-2"></i> Nouvelle Proposition
    <% end %>
  </div>

  <%# ========================================================== %>
  <%# BLOC DE FILTRES RAPIDES ET AVANCÉS %>
  <%# ========================================================== %>
  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <%= form_with url: fve_mission_proposals_path, method: :get, local: true, class: "row g-3" do %>

      <div class="col-12"><h6 class="fw-bold mb-1">Filtre Rapide (Nom & Client)</h6></div>

      <div class="col-md-6 col-lg-4">
        <%= text_field_tag :query,
                           params[:query],
                           class: "form-control",
                           placeholder: "Nom, Prénom ou Pseudo du Merch..." %>
      </div>

      <div class="col-md-6 col-lg-4">
        <%= text_field_tag :company,
                           params[:company],
                           class: "form-control",
                           placeholder: "Nom du Client / Compagnie..." %>
      </div>

      <%# Placeholder pour alignement %>
      <div class="col-md-6 col-lg-4"></div>

      <div class="col-12"><hr class="mt-4 mb-3"></div>

      <div class="col-12"><h6 class="fw-bold mb-3">Filtres Période et Rôle</h6></div>

      <div class="col-md-6 col-lg-3">
        <%= label_tag :start_date, "Mission à partir du", class: "form-label fw-semibold" %>
        <%= date_field_tag :start_date,
                           params[:start_date],
                           class: "form-control" %>
      </div>

      <div class="col-md-6 col-lg-3">
        <%= label_tag :end_date, "Mission jusqu'au", class: "form-label fw-semibold" %>
        <%= date_field_tag :end_date,
                           params[:end_date],
                           class: "form-control" %>
      </div>

      <div class="col-md-6 col-lg-3">
        <%= label_tag :preference, "Rôle Merch souhaité", class: "form-label fw-semibold" %>
        <%= select_tag :preference,
                       options_for_select([['Tous les rôles', nil], ['Merchandising', :merch], ['Animation / Démo', :anim]], params[:preference]),
                       class: "form-select" %>
      </div>

      <div class="col-md-6 col-lg-3 d-flex align-items-end justify-content-end">
        <%= button_tag type: :submit, class: "btn btn-orange fw-semibold px-4 me-2" do %>
            <i class="fa-solid fa-filter me-2"></i> Filtrer
        <% end %>
        <%= link_to "Réinit.", fve_mission_proposals_path, class: "btn btn-outline-secondary" %>
      </div>

    <% end %>
  </div>
  <%# ========================================================== %>

  <%# Ces variables étaient là pour un filtre de style, je les laisse au cas où. %>
  <% filter_params = %w[query company start_date end_date preference] %>
  <% is_filtered = filter_params.any? { |key| params[key].present? } %>

  <p class="text-muted mb-3">
    <strong><%= @proposals.count %></strong> proposition(s) trouvée(s)
  </p>

  <%# ========================================================== %>
  <%# CONTENU PRINCIPAL PAR ONGLETS (CORRIGÉ) %>
  <%# ========================================================== %>

  <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">

    <%# ONGLET EN ATTENTE : actif si @active_tab est 'pending' %>
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold <%= 'active' if @active_tab == 'pending' %>"
              id="pills-pending-tab"
              data-bs-toggle="pill"
              data-bs-target="#pills-pending"
              type="button"
              role="tab">
        ⏳ En attente (<%= @pending_proposals.count %>)
      </button>
    </li>

    <%# ONGLET VALIDÉES : actif si @active_tab est 'accepted' %>
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold <%= 'active' if @active_tab == 'accepted' %>"
              id="pills-accepted-tab"
              data-bs-toggle="pill"
              data-bs-target="#pills-accepted"
              type="button"
              role="tab">
        ✅ Validées (<%= @accepted_proposals.count %>)
      </button>
    </li>

    <%# ONGLET HISTORIQUE : actif si @active_tab correspond à l'historique (rejected, declined, cancelled) %>
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold <%= 'active' if ['declined', 'cancelled', 'rejected'].include?(@active_tab) %>"
              id="pills-history-tab"
              data-bs-toggle="pill"
              data-bs-target="#pills-history"
              type="button"
              role="tab">
        ❌ Refus / Annul. (<%= @history_proposals.count %>)
      </button>
    </li>
  </ul>

  <div class="tab-content" id="pills-tabContent">

    <%# PANNEAU 1 : EN ATTENTE %>
    <div class="tab-pane fade <%= 'show active' if @active_tab == 'pending' %>" id="pills-pending" role="tabpanel">
      <% if @pending_proposals.any? %>
        <div class="row g-4">
          <%= render partial: "proposal_card", collection: @pending_proposals, as: :proposal %>
        </div>
      <% else %>
        <div class="alert alert-light text-center py-5 rounded-4 border">
          <h4 class="fw-bold text-muted">Aucune proposition en attente.</h4>
        </div>
      <% end %>
    </div>

    <%# PANNEAU 2 : VALIDÉES %>
    <div class="tab-pane fade <%= 'show active' if @active_tab == 'accepted' %>" id="pills-accepted" role="tabpanel">
      <% if @accepted_proposals.any? %>
        <div class="row g-4">
          <%= render partial: "proposal_card", collection: @accepted_proposals, as: :proposal %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">Rien à afficher dans les missions validées.</div>
      <% end %>
    </div>

    <%# PANNEAU 3 : HISTORIQUE %>
    <div class="tab-pane fade <%= 'show active' if ['declined', 'cancelled', 'rejected'].include?(@active_tab) %>" id="pills-history" role="tabpanel">
      <% if @history_proposals.any? %>
        <div class="row g-4">
          <%= render partial: "proposal_card", collection: @history_proposals, as: :proposal %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">Aucun historique de refus ou annulation.</div>
      <% end %>
    </div>

  </div>
</div>
