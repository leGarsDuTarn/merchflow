<div class="container mt-4 mb-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-orange mb-0">Tableau de bord</h2>
      <p class="text-muted small mb-0">Bonne journée, <%= current_user.firstname %> !</p>
    </div>
    <% if @premium %>
      <span class="badge bg-success rounded-pill px-3 py-2">
        <i class="bi bi-star-fill me-1"></i> Premium
      </span>
    <% else %>
      <span class="badge bg-secondary rounded-pill px-3 py-2">Standard</span>
    <% end %>
  </div>

  <div class="row g-3 mb-4">

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm border-0 bg-orange-light h-100"> <div class="card-body text-center">
          <h6 class="text-muted text-uppercase small fw-bold">Sur le terrain ce jour</h6>
          <p class="display-5 fw-bold text-orange mb-0"><%= @missions_today_count %></p>
          <small class="text-muted">Missions actives</small>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <h6 class="text-muted text-uppercase small fw-bold">Propositions en attente</h6>
          <p class="display-5 fw-bold text-secondary mb-0"><%= @pending_proposals_count %></p>
          <small class="text-muted">À relancer</small>
        </div>
      </div>
    </div>

    <div class="col-md-12 col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
           <% if @alerts.any? %>
             <h6 class="text-danger fw-bold text-uppercase small mb-2">⚠️ Attention requise</h6>
             <p class="mb-0 text-center small">
               <strong><%= @alerts.count %></strong> propositions refusées récemment.<br>
               <a href="#alerts-section" class="text-danger text-decoration-underline">Voir les détails</a>
             </p>
           <% else %>
             <div class="text-success text-center">
               <i class="bi bi-check-circle-fill fs-3"></i>
               <p class="mb-0 fw-bold small mt-1">Tout roule !</p>
             </div>
           <% end %>
        </div>
      </div>
    </div>
  </div>

  <% if @alerts.any? %>
    <div id="alerts-section" class="card shadow-sm border-start border-4 border-danger mb-5">
      <div class="card-body">
        <h5 class="fw-bold text-danger mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>Missions à re-staffer (Refusées)</h5>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Mission</th>
                <th>Merch ayant refusé</th>
                <th>Date du refus</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% @alerts.each do |proposal| %>
                <tr>
                  <td class="fw-bold"><%= proposal.mission.title %></td> <td><%= proposal.merch.first_name %> <%= proposal.merch.last_name %></td>
                  <td class="text-muted small"><%= time_ago_in_words(proposal.updated_at) %></td>
                  <td>
                    <%= link_to "Trouver un remplaçant",
                        "#",
                        class: "btn btn-sm btn-outline-danger fw-bold" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <h4 class="fw-bold text-orange mb-3">Mon Équipe</h4>

  <% if @favorite_merchs.any? %>
    <h6 class="text-muted text-uppercase small mb-3"><i class="bi bi-heart-fill text-danger me-1"></i> Mes Favoris</h6>
    <div class="row g-3 mb-4">
      <%= render partial: "merch_card", collection: @favorite_merchs, as: :merch, locals: { is_favorite: true } %>
    </div>
  <% end %>

  <h6 class="text-muted text-uppercase small mb-3">Autres Merchs du secteur</h6>
  <% if @other_merchs.any? %>
    <div class="row g-3">
      <%= render partial: "merch_card", collection: @other_merchs, as: :merch, locals: { is_favorite: false } %>
    </div>
  <% else %>
    <p class="text-muted">Aucun autre merch disponible.</p>
  <% end %>

</div>
