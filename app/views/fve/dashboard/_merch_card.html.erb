<%# DÉFINITION DES VARIABLES AU DÉBUT %>
<% is_premium_fve = @premium || current_user.premium? %>
<% merch_settings = merch.merch_setting || MerchSetting.new %>

<div class="col-md-6 col-lg-4">
  <div class="card shadow-sm bg-white p-3 rounded-4 h-100 border-0 position-relative card-hover-effect">

    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <%# On utilise ici le champ 'allow_identity' de ton schema %>
        <% if is_premium_fve && merch_settings.allow_identity %>
          <%# CAS 1 : Premium + Le merch accepte de montrer son identité %>
          <h5 class="fw-bold text-orange mb-1">
            <%= merch.firstname %> <%= merch.lastname %>
          </h5>
        <% elsif is_premium_fve %>
          <%# CAS 2 : Premium MAIS identité masquée -> On affiche le Username en clair %>
          <h5 class="fw-bold text-orange mb-1">
            <%= merch.username %>
          </h5>
        <% else %>
          <%# CAS 3 : Non-Premium -> Username flouté %>
          <h5 class="fw-bold text-orange mb-1" style="filter: blur(5px); user-select: none; opacity: 0.8;">
            <%= merch.username %>
          </h5>
        <% end %>
        <%# ------------------- %>

        <p class="text-muted mb-0 small">
          <i class="bi bi-geo-alt-fill me-1"></i><%= merch.city %>
        </p>
      </div>

      <%# --- LOGIQUE FAVORIS --- %>
      <div>
        <% if is_premium_fve %>
          <%# --- ACCES PREMIUM : LOGIQUE D'ORIGINE --- %>
          <% if current_user.favorite_merchs.exists?(merch.id) %>
            <%= button_to fve_favorite_path(merch.id),
                method: :delete,
                class: "btn p-0 border-0 bg-transparent",
                form: { style: 'display:inline-block;', data: { turbo_frame: '_top' } } do %>
              <i class="fas fa-heart text-danger fs-5" style="cursor: pointer;" title="Retirer des favoris"></i>
            <% end %>
          <% else %>
            <%= button_to fve_favorites_path(merch_id: merch.id),
                method: :post,
                class: "btn p-0 border-0 bg-transparent",
                form: { style: 'display:inline-block;', data: { turbo_frame: '_top' } } do %>
              <i class="far fa-heart text-muted fs-5" style="cursor: pointer;" title="Ajouter aux favoris"></i>
            <% end %>
          <% end %>

        <% else %>
          <%# --- ACCES NON-PREMIUM : CADENAS --- %>
          <button class="btn p-0 border-0 bg-transparent" disabled style="cursor: not-allowed;">
             <i class="fas fa-lock text-muted fs-5" title="Fonctionnalité Premium"></i>
          </button>
        <% end %>
      </div>
      <%# ----------------------- %>

    </div>

    <div class="mb-3 border-top pt-3">
        <%# AFFICHAGE CONDITIONNEL : TÉLÉPHONE %>
      <% if is_premium_fve && merch_settings.allow_contact_phone %>
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-telephone-fill me-2 text-orange small"></i>
          <span class="fw-semibold text-dark"><%= merch.phone_number %></span>
        </div>
      <% else %>
        <div class="d-flex align-items-center mb-2 text-muted">
          <i class="bi bi-telephone-fill me-2 small"></i>
          <span>
            <% if is_premium_fve %>
              Numéro non partagé par le Merch
            <% else %>
              <span class="fst-italic small">Premium requis pour voir</span>
            <% end %>
          </span>
        </div>
      <% end %>

      <%# AFFICHAGE CONDITIONNEL : EMAIL %>
      <% if is_premium_fve && merch_settings.allow_contact_email %>
        <div class="d-flex align-items-center">
          <i class="bi bi-envelope-fill me-2 text-orange small"></i>
          <span class="fw-semibold text-dark text-truncate"><%= merch.email %></span>
        </div>
      <% else %>
        <div class="d-flex align-items-center text-muted">
          <i class="bi bi-envelope-fill me-2 small"></i>
          <span>
             <% if is_premium_fve %>
              Email non partagé par le Merch
            <% else %>
              <span class="fst-italic small">Premium requis pour voir</span>
            <% end %>
          </span>
        </div>
      <% end %>
    </div>

    <div class="d-grid gap-2 mt-auto pt-3 border-top">
      <div class="d-flex gap-2">
        <%= link_to "Profil", fve_merch_path(merch), class: "btn btn-sm btn-orange flex-grow-1 fw-semibold" %>
        <%= link_to "Planning", fve_planning_path(merch), class: "btn btn-sm btn-orange-outline flex-grow-1 fw-semibold" %>
      </div>
    </div>

  </div>
</div>
