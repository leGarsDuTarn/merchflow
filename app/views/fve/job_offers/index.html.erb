<div class="bg-light min-vh-100 py-3 py-lg-5">
  <div class="container">

    <%# --- EN-TÊTE DASHBOARD --- %>
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4 mb-lg-5">
      <div>
        <h1 class="fw-bold text-dark m-0">Mes Annonces</h1>
        <p class="text-muted small mb-0">Gérez vos recrutements et suivez les candidatures.</p>
      </div>

      <%= link_to new_fve_job_offer_path, class: "btn btn-orange rounded-pill px-4 py-2 fw-bold shadow-sm transition-hover d-flex align-items-center justify-content-center" do %>
        <i class="fa-solid fa-plus me-2"></i>Nouvelle annonce
      <% end %>
    </div>

    <%# --- MOTEUR DE RECHERCHE --- %>
    <div class="card shadow-sm border-0 rounded-4 mb-5 overflow-hidden">
      <div class="card-header bg-white border-bottom-0 p-3 pb-0">
        <h6 class="fw-bold text-dark mb-0 d-flex align-items-center">
          <span class="bg-orange-light text-orange rounded-3 p-2 me-3 d-inline-flex">
            <i class="fa-solid fa-filter fa-sm"></i>
          </span>
          Filtrer mes annonces
        </h6>
      </div>

      <div class="card-body p-3 bg-white">
        <%= form_with url: fve_job_offers_path, method: :get, local: true, class: "row g-3" do |f| %>

          <%# Filtre 1 : Recherche textuelle %>
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold small text-muted text-uppercase ls-1">Mot-clé</label>
            <div class="input-group shadow-sm rounded-3 overflow-hidden">
              <span class="input-group-text bg-light border-0 ps-3 text-orange"><i class="fa-solid fa-magnifying-glass"></i></span>
              <%= f.text_field :query, value: params[:query], class: "form-control bg-light border-0 py-2", placeholder: "Ville, Titre..." %>
            </div>
          </div>

          <%# Filtre 2 : Enseigne (Store Name) %>
          <%# On récupère uniquement les enseignes des offres Draft/Published du FVE connecté %>
          <% available_stores = current_user.created_job_offers.where(status: ['draft', 'published']).distinct.pluck(:store_name).sort %>
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold small text-muted text-uppercase ls-1">Enseigne</label>
            <div class="input-group shadow-sm rounded-3 overflow-hidden">
              <span class="input-group-text bg-light border-0 ps-3 text-orange"><i class="fa-solid fa-store"></i></span>
              <%= f.select :store_name,
                           available_stores,
                           { include_blank: "Toutes les enseignes", selected: params[:store_name] },
                           { class: "form-select bg-light border-0 py-2" } %>
            </div>
          </div>

          <%# Filtre 3 : Statut %>
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold small text-muted text-uppercase ls-1">Statut</label>
            <div class="input-group shadow-sm rounded-3 overflow-hidden">
              <span class="input-group-text bg-light border-0 ps-3 text-orange"><i class="fa-solid fa-toggle-on"></i></span>
              <%= f.select :status,
                           [['Brouillon', 'draft'], ['Publiée', 'published'], ['Suspendue', 'suspended']],
                           { include_blank: "Tous les statuts", selected: params[:status] },
                           { class: "form-select bg-light border-0 py-2" } %>
            </div>
          </div>

          <div class="col-12 d-flex justify-content-end mt-3">
             <%= link_to fve_job_offers_path, class: "btn btn-link text-muted text-decoration-none small fw-bold me-3" do %>
               Effacer
             <% end %>
             <button type="submit" class="btn btn-orange btn-sm rounded-pill px-4 fw-bold shadow-sm">
               Filtrer
             </button>
          </div>
        <% end %>
      </div>
    </div>

    <%# --- LISTE DES RÉSULTATS --- %>
    <% if @job_offers.empty? %>

      <div class="text-center text-muted mt-5 py-5 bg-white rounded-4 shadow-sm border border-dashed">
        <div class="bg-orange-light rounded-circle d-inline-flex p-4 mb-3 text-orange">
          <i class="fa-solid fa-folder-open fa-3x"></i>
        </div>
        <h4 class="fw-bold text-dark">Aucune annonce trouvée</h4>
        <p class="mb-0 text-muted small">Modifiez vos filtres ou créez une nouvelle annonce.</p>
      </div>

    <% else %>

      <div class="row g-4">
        <% @job_offers.each do |offer| %>
          <%
             # Calculs rapides pour la Card
             recruited = offer.recruited_count
             target = offer.headcount_required
             pending = offer.pending_count
             progress = (recruited.to_f / target.to_f) * 100
          %>

          <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm border-0 rounded-4 h-100 position-relative overflow-hidden transition-hover bg-white">

              <%# Badge Statut (Absolu) %>
              <div class="position-absolute top-0 end-0 m-3 z-2">
                <% if offer.status == 'published' %>
                  <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2 py-1 shadow-sm small fw-bold">
                    En ligne
                  </span>
                <% else %>
                  <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 rounded-pill px-2 py-1 shadow-sm small fw-bold">
                    Brouillon
                  </span>
                <% end %>
              </div>

              <div class="card-body p-3 d-flex flex-column h-100">

                <%# --- HEADER CARD --- %>
                <div class="mb-3">
                  <span class="badge bg-orange-light text-orange border border-orange-subtle rounded-pill px-2 py-1 small fw-normal mb-2">
                    <%= offer.mission_type.capitalize %>
                  </span>
                  <h5 class="fw-bold text-dark mb-1 text-truncate" title="<%= offer.title %>">
                    <%= link_to offer.title, fve_job_offer_path(offer), class: "text-decoration-none text-dark stretched-link" %>
                  </h5>
                  <div class="d-flex align-items-center text-muted small">
                    <i class="fa-solid fa-store me-2 text-orange opacity-75"></i>
                    <span class="text-truncate"><%= offer.store_name %> • <%= offer.city %> (<%= offer.department_code %>)</span>
                  </div>
                </div>

                <%# --- PLANNING BOX --- %>
                <div class="bg-light p-3 rounded-4 small mb-3 border border-light">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fa-regular fa-calendar text-orange me-2"></i>
                    <span class="fw-bold text-dark">
                      <% if offer.start_date.to_date == offer.end_date.to_date %>
                         Le <%= l(offer.start_date.to_date, format: "%d %b") %>
                      <% else %>
                         Du <%= l(offer.start_date.to_date, format: "%d %b") %> au <%= l(offer.end_date.to_date, format: "%d %b") %>
                      <% end %>
                    </span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                     <div>
                       <i class="fa-regular fa-clock text-orange me-2"></i>
                       <span class="text-muted"><%= offer.job_offer_slots.count %> créneau(x)</span>
                     </div>
                     <span class="fw-bold text-dark"><%= number_to_currency(offer.hourly_rate) %>/h</span>
                  </div>
                </div>

                <%# --- PROGRESS BAR RECRUTEMENT --- %>
                <div class="mt-auto mb-3">
                  <div class="d-flex justify-content-between align-items-end mb-1">
                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">RECRUTEMENT</small>
                    <small class="text-dark fw-bold"><%= recruited %> / <%= target %></small>
                  </div>
                  <div class="progress" style="height: 6px; border-radius: 10px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: <%= progress %>%" aria-valuenow="<%= progress %>" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="mt-1 text-end">
                    <% if pending > 0 %>
                      <span class="badge bg-orange text-white rounded-pill" style="font-size: 0.65rem;"><%= pending %> en attente</span>
                    <% else %>
                      <small class="text-muted italic" style="font-size: 0.65rem;">À jour</small>
                    <% end %>
                  </div>
                </div>

                <%# --- FOOTER ACTIONS --- %>
                <div class="d-flex gap-2 position-relative z-2 pt-2 border-top border-light">
                  <%= link_to fve_job_offer_path(offer),
                      class: "btn btn-orange w-100 fw-bold rounded-3 py-2 small shadow-sm",
                      title: "Gérer l'annonce" do %>
                    Gérer
                  <% end %>

                  <%= link_to edit_fve_job_offer_path(offer),
                      class: "btn btn-white border fw-bold rounded-3 shadow-sm d-flex align-items-center justify-content-center",
                      style: "width: 40px;",
                      title: "Modifier" do %>
                    <i class="fa-solid fa-pen text-muted"></i>
                  <% end %>
                </div>

              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

  </div>
</div>
