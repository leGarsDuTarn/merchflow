<div class="container my-5">

  <!-- TITRE -->
  <h1 class="fw-bold text-orange mb-4 text-center">
    Planning de <%= @merch_user.displayable_name(current_user) %>
  </h1>

  <!-- Navigation mois -->
  <div class="d-flex justify-content-between align-items-center mb-4">

    <%= link_to fve_planning_path(@merch_user, year: @prev_year, month: @prev_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-semibold text-capitalize m-0">
      <%= I18n.l Date.new(@year, @month), format: "%B %Y" %>
    </h3>

    <%= link_to fve_planning_path(@merch_user, year: @next_year, month: @next_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>

  </div>


  <!-- Message mobile -->
  <div class="d-lg-none text-center mb-3 animate__animated animate__fadeIn">
    <div class="d-inline-block bg-light px-3 py-1 rounded-pill border">
      <small class="text-muted">
        Vue simplifi√©e (jours libres masqu√©s)
      </small>
    </div>
  </div>


  <!-- Jours de la semaine (desktop) -->
  <div class="d-none d-lg-block shadow-sm rounded-4 p-3 mb-2 bg-white">
    <div class="week-headers">
      <div>Lun</div>
      <div>Mar</div>
      <div>Mer</div>
      <div>Jeu</div>
      <div>Ven</div>
      <div>Sam</div>
      <div>Dim</div>
    </div>
  </div>


  <!-- CALENDRIER -->
  <div class="calendar-wrapper">
    <div class="calendar-grid shadow-sm rounded-4 p-3">

      <% @weeks.each do |week| %>

        <div class="calendar-row">

          <% week.each do |day| %>
            <% raw_sessions = @sessions_by_date[day] || [] %>
            <% sessions = raw_sessions.sort_by(&:start_time) %>

            <%# üî• 1. On cherche l'indisponibilit√© pour ce jour %>
            <% unav = @unavailabilities.find { |u| u.date == day } %>

            <div class="calendar-cell rounded-3 position-relative
                        <%= 'today' if day == Date.today %>
                        <%= sessions.any? ? 'cell-busy' : 'cell-available' %>
                        <%= 'cell-unavailable' if unav.present? %>"> <%# üî• 2. On ajoute la classe CSS %>

              <div class="d-flex justify-content-between align-items-start p-1">
                <div class="date-number fw-semibold <%= 'text-orange' if day.month == @month %>">
                  <%= day.day %>
                </div>

                <%# Petit ic√¥ne visuel (optionnel) %>
                <% if unav.present? %>
                  <i class="fa-solid fa-ban text-danger small"></i>
                <% end %>
              </div>

              <% if unav.present? %>
                <div class="p-1 mb-2">
                  <div class="text-danger fw-bold small">Indisponible</div>
                  <% if unav.notes.present? %>
                    <div class="text-muted small fst-italic" style="font-size: 0.75rem;">
                      <%= unav.notes %>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <div class="sessions-container">
                <% sessions.each do |ws| %>

                  <div class="session-item bg-white rounded-3 p-2 mb-1 border text-truncate">
                    <div class="fw-bold text-dark text-truncate" style="line-height: 1.1;">
                      <%= ws.contract.agency_label %>
                    </div>
                    <div class="text-muted small">
                      <%= ws.start_time.strftime("%H:%M") %> ‚Äì <%= ws.end_time.strftime("%H:%M") %>
                    </div>
                  </div>

                <% end %>
              </div>

            </div>
          <% end %>

        </div>
      <% end %>

    </div>
  </div>


  <!-- RETOUR -->
  <div class="text-center mt-4">
    <%= link_to "Retour", fve_merch_index_path, class: "btn btn-orange-outline fw-semibold px-4" %>
  </div>

</div>
