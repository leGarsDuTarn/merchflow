<%# app/views/fve/merch/show.html.erb %>

<%# DÉFINITION VARIABLE PREMIUM %>
<% is_premium = @premium || current_user.premium? %>

<div class="container mt-4 mb-5" style="max-width: 750px;">

  <div class="text-center my-5">
    <h1 class="fw-bold text-orange">Détail du Profil</h1>
  </div>

  <div class="card border-0 shadow rounded-5 overflow-hidden">

    <div class="card-body p-0">
      <div class="bg-light p-5 text-center position-relative">

        <%# ================================================================= %>
        <%# BOUTON COEUR (LOGIQUE PREMIUM / CADENAS) %>
        <%# ================================================================= %>
        <div class="position-absolute top-0 end-0 m-4">

          <% if is_premium %>
            <%# --- MODE PREMIUM : FONCTION FAVORIS ACTIVE --- %>
            <% is_favorited = current_user.favorites_given.exists?(merch_id: @merch_user.id) %>

            <%= link_to toggle_favorite_fve_merch_path(@merch_user),
                        data: { turbo_method: :post },
                        class: "btn bg-white shadow-sm rounded-circle d-flex align-items-center justify-content-center border-0 hover-scale link-heart",
                        style: "width: 50px; height: 50px;" do %>

              <% if is_favorited %>
                <i class="fa-solid fa-heart text-danger fs-4"></i>
              <% else %>
                <i class="fa-regular fa-heart text-secondary fs-4"></i>
              <% end %>
            <% end %>

          <% else %>
            <%# --- MODE NON-PREMIUM : CADENAS --- %>
            <button class="btn bg-white shadow-sm rounded-circle d-flex align-items-center justify-content-center border-0"
                    style="width: 50px; height: 50px; cursor: not-allowed;" disabled>
              <i class="fa-solid fa-lock text-muted fs-4"></i>
            </button>
          <% end %>

        </div>
        <%# ================================================================= %>


        <%# AVATAR %>
        <div class="avatar-circle mx-auto mb-3 bg-white shadow-sm d-flex align-items-center justify-content-center rounded-circle" style="width: 100px; height: 100px;">
          <i class="fa-solid fa-user fa-3x text-orange"></i>
        </div>

        <%# NOM DU MERCH (LOGIQUE FLOUTAGE) %>
        <% if is_premium %>
          <h2 class="fw-bold mb-1"><%= @name %></h2>
        <% else %>
          <%# Nom flouté visuellement %>
          <h2 class="fw-bold mb-1" style="filter: blur(6px); user-select: none; opacity: 0.6;">
            <%= @merch_user.username %>
          </h2>
          <p class="text-orange fw-bold small mb-0"><i class="fa-solid fa-lock me-1"></i> Identité masquée</p>
        <% end %>


        <%# BADGE CONTRAT AGENCE %>
        <div class="mt-3">
          <% if @contracts_with_my_agency.any? %>
            <span class="badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill">
              <i class="fa-solid fa-check-circle me-1"></i> Sous contrat (Agence <%= current_user.agency.capitalize %>)
            </span>
          <% else %>
            <span class="badge bg-secondary-subtle text-secondary px-3 py-2 rounded-pill">
              <i class="fa-solid fa-file-contract me-1"></i> Pas de contrat actif
            </span>
          <% end %>
        </div>

      </div>
    </div>

    <div class="card-body p-4 p-md-5">

      <div class="row g-4">

        <%# COLONNE GAUCHE : LOCALISATION (VILLE & CP RESTAURÉS) %>
        <div class="col-md-6 border-end-md">
          <h6 class="text-uppercase text-muted fw-bold mb-3 small tracking-wide">
            <i class="fa-solid fa-location-arrow me-2 text-orange"></i> Localisation
          </h6>

          <ul class="list-unstyled mb-0">
            <li class="mb-3 d-flex align-items-center">
              <div class="icon-box-sm bg-orange-light text-orange rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                <i class="fa-solid fa-city"></i>
              </div>
              <div>
                <%# RESTAURATION : Ville et Code Postal %>
                <small class="text-muted d-block">Ville & Code Postal</small>
                <span class="fw-bold text-dark">
                  <%= @merch_user.city.presence || "—" %> (<%= @merch_user.zipcode.presence || "—" %>)
                </span>
              </div>
            </li>

            <%# L'ADRESSE PRÉCISE (rue/numéro) RESTE SUPPRIMÉE %>

          </ul>
        </div>

        <%# COLONNE DROITE : CONTACT %>
        <div class="col-md-6 ps-md-4">
          <h6 class="text-uppercase text-muted fw-bold mb-3 small tracking-wide">
            <i class="fa-solid fa-address-book me-2 text-orange"></i> Coordonnées
          </h6>

          <ul class="list-unstyled mb-0">
            <%# EMAIL %>
            <li class="mb-3 d-flex align-items-center">
              <i class="fa-solid fa-envelope text-muted me-3" style="width: 20px;"></i>
              <% if is_premium && @email %>
                <a href="mailto:<%= @email %>" class="text-decoration-none text-dark fw-bold"><%= @email %></a>
              <% else %>
                <span class="text-muted fst-italic">
                  <i class="fa-solid fa-eye-slash me-1"></i>
                  <%= is_premium ? "Masqué" : "Premium requis" %>
                </span>
              <% end %>
            </li>

            <%# TÉLÉPHONE %>
            <li class="mb-3 d-flex align-items-center">
              <i class="fa-solid fa-phone text-muted me-3" style="width: 20px;"></i>
              <% if is_premium && @phone %>
                <a href="tel:<%= @phone %>" class="text-decoration-none text-dark fw-bold"><%= @phone %></a>
              <% else %>
                <span class="text-muted fst-italic">
                  <i class="fa-solid fa-eye-slash me-1"></i>
                  <%= is_premium ? "Masqué" : "Premium requis" %>
                </span>
              <% end %>
            </li>

            <%# PRÉFÉRENCE DE COM %>
            <li class="mt-4 pt-3 border-top">
              <small class="text-muted d-block mb-2">Canal de communication préféré :</small>
              <% pref = @merch_user.merch_setting&.preferred_contact_channel %>
              <% if pref.present? %>
                <div class="d-inline-flex align-items-center px-3 py-2 bg-orange-light text-orange rounded-3 fw-bold">
                  <% case pref.downcase %>
                  <% when 'whatsapp' %>
                    <i class="fa-brands fa-whatsapp me-2 fs-5"></i> WhatsApp
                  <% when 'sms' %>
                    <i class="fa-solid fa-comment-sms me-2 fs-5"></i> SMS
                  <% when 'email' %>
                    <i class="fa-solid fa-envelope me-2 fs-5"></i> Email
                  <% when 'telephone', 'phone' %>
                    <i class="fa-solid fa-phone-volume me-2 fs-5"></i> Appel téléphonique
                  <% else %>
                    <i class="fa-solid fa-comments me-2"></i> <%= pref.capitalize %>
                  <% end %>
                </div>
              <% else %>
                <span class="text-muted small">Non spécifié</span>
              <% end %>
            </li>
          </ul>
        </div>
      </div>

      <%# ROLES ET COMPETENCES %>
      <% if @merch_user.merch_setting&.mission_preferences.present? %>
        <hr class="my-4 text-muted opacity-25">
        <h6 class="text-uppercase text-muted fw-bold mb-3 small tracking-wide">
          <i class="fa-solid fa-tags me-2 text-orange"></i> Rôles & Compétences
        </h6>
        <div class="d-flex flex-wrap gap-2">
          <% @merch_user.merch_setting.mission_preferences.split(',').each do |role| %>
            <span class="badge bg-light text-dark border border-light-subtle py-2 px-3 rounded-pill">
              <%= role.strip %>
            </span>
          <% end %>
        </div>
      <% end %>

      <%# BLOC PLANNING (ACTION) %>
      <div class="mt-5 p-4 rounded-4 bg-light border border-light-subtle">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
          <div class="mb-3 mb-md-0 text-center text-md-start">
            <h5 class="fw-bold mb-1">Planning d'activité</h5>
            <% if @merch_user.merch_setting&.share_planning? %>
              <p class="text-success small mb-0"><i class="fa-solid fa-unlock me-1"></i> Planning partagé et accessible</p>
            <% else %>
              <p class="text-danger small mb-0"><i class="fa-solid fa-lock me-1"></i> Planning privé</p>
            <% end %>
          </div>

          <div class="">
             <% if @merch_user.merch_setting&.share_planning? %>
                <%= link_to fve_planning_path(@merch_user), class: "btn btn-orange rounded-pill px-4 py-2 shadow-sm fw-bold icon-link" do %>
                  <i class="fa-solid fa-calendar-days me-2"></i> Voir le planning
                <% end %>
             <% else %>
               <button class="btn btn-secondary rounded-pill px-4 py-2 opacity-75" disabled>
                 <i class="fa-solid fa-eye-slash me-2"></i> Planning masqué
               </button>
             <% end %>
          </div>
        </div>
      </div>

      <%# BOUTON RETOUR %>
      <div class="text-center mt-4">
        <%= link_to fve_merch_index_path, class: "text-muted text-decoration-none small fw-semibold hover-orange" do %>
          <i class="fa-solid fa-arrow-left me-1"></i> Retour à la recherche
        <% end %>
      </div>

    </div>
  </div>
</div>
