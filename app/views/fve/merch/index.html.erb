<div class="container mt-4 mb-5">

  <h1 class="fw-bold text-orange text-center mb-4">
    Recherche de Merchandisers
  </h1>

  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <%= form_with url: fve_merch_index_path, method: :get, local: true, class: "row g-3" do |f| %>

      <%# ========================================================== %>
      <%# üö® NOUVEAU BLOC 1 : RECHERCHE NOM/PRENOM/PSEUDO (En t√™te) %>
      <%# ========================================================== %>
      <div class="col-12">
        <h6 class="fw-bold mb-1">Recherche rapide par nom</h6>
      </div>
      <div class="col-md-12 col-lg-6">
        <%= text_field_tag :query,
                           params[:query],
                           class: "form-control form-control-lg",
                           placeholder: "Nom, Pr√©nom ou Pseudo du Merchandiser..." %>
      </div>
      <div class="col-md-12 col-lg-6 d-flex align-items-center">
        <%= f.submit "Rechercher", class: "btn btn-orange fw-semibold px-4 btn-lg me-2" %>
        <%= link_to "R√©initialiser", fve_merch_index_path, class: "btn btn-outline-secondary btn-lg" %>
      </div>

      <div class="col-12"><hr class="mt-4 mb-3"></div>

      <div class="col-12">
        <h6 class="fw-bold mb-3">Filtres G√©ographiques et Horaires</h6>
      </div>

      <%# ========================================================== %>
      <%# BLOC 2 : G√âOGRAPHIE & P√âRIODE %>
      <%# ========================================================== %>

      <div class="col-md-6 col-lg-4">
        <%= f.label :city, "Ville", class: "form-label fw-semibold" %>
        <%= f.text_field :city,
            value: params[:city],
            class: "form-control",
            placeholder: "Ex: Paris, Lyon..." %>
      </div>

      <div class="col-md-6 col-lg-4">
        <%= f.label :zipcode, "Code postal", class: "form-label fw-semibold" %>
        <%= f.text_field :zipcode,
            value: params[:zipcode],
            class: "form-control",
            placeholder: "Ex: 75001" %>
      </div>

      <div class="col-md-6 col-lg-4">
        <%= f.label :department, "D√©partement", class: "form-label fw-semibold" %>
        <%= f.text_field :department,
            value: params[:department],
            class: "form-control",
            placeholder: "Ex: 75, 69..." %>
      </div>

      <div class="col-md-6 col-lg-4">
        <%= f.label :start_date, "Disponible du", class: "form-label fw-semibold" %>
        <%= f.date_field :start_date,
            value: params[:start_date],
            class: "form-control" %>
      </div>

      <div class="col-md-6 col-lg-4">
        <%= f.label :end_date, "Au", class: "form-label fw-semibold" %>
        <%= f.date_field :end_date,
            value: params[:end_date],
            class: "form-control" %>
      </div>

      <%# ========================================================== %>
      <%# BLOC 3 : PR√âF√âRENCES & CONTRATS %>
      <%# ========================================================== %>
      <div class="col-12"><h6 class="mt-3 fw-bold">Pr√©f√©rences et Historique</h6></div>

      <div class="col-md-6 col-lg-4">
        <%= f.label :company, "A travaill√© pour", class: "form-label fw-semibold" %>
        <%= f.text_field :company,
            value: params[:company],
            class: "form-control",
            placeholder: "Nom de l'entreprise" %>
      </div>


      <div class="col-md-6 col-lg-4">
        <div class="form-check">
          <%= f.check_box :prefers_merch,
              { class: "form-check-input", checked: params[:prefers_merch] == "1" },
              "1", "0" %>
          <%= f.label :prefers_merch, "Recherche missions Merchandising", class: "form-check-label" %>
        </div>
        <div class="form-check">
          <%= f.check_box :prefers_anim,
              { class: "form-check-input", checked: params[:prefers_anim] == "1" },
              "1", "0" %>
          <%= f.label :prefers_anim, "Recherche missions Animation / D√©mo", class: "form-check-label" %>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="form-check">
          <%= f.check_box :has_contract_with_me,
              { class: "form-check-input", checked: params[:has_contract_with_me] == "1" },
              "1", "0" %>
          <%= f.label :has_contract_with_me, "A d√©j√† un contrat avec votre FVE", class: "form-check-label" %>
        </div>
        <div class="form-check">
          <%= f.check_box :only_with_contact,
              { class: "form-check-input", checked: params[:only_with_contact] == "1" },
              "1", "0" %>
          <%= f.label :only_with_contact, "Coordonn√©es visibles uniquement", class: "form-check-label" %>
        </div>
      </div>


      <%# Les boutons de soumission sont maintenant en haut pour une meilleure UX %>
      <%# üö® J'ai d√©plac√© les boutons principaux en haut, mais si vous voulez les garder ici pour l'UX traditionnelle: %>

      <%# <div class="col-12 d-flex gap-2 justify-content-end mt-4"> %>
        <%# <%= f.submit "Rechercher", class: "btn btn-orange fw-semibold px-4" %>
        <%# <%= link_to "R√©initialiser", fve_merch_index_path, class: "btn btn-green" %>
      <%# </div> %>


    <% end %>
  </div>

  <% search_params = %w[query city zipcode department start_date end_date company has_contract_with_me only_with_contact prefers_merch prefers_anim] %>
  <% has_search = search_params.any? { |key| params[key].present? } %>

  <% if has_search || params[:query].present? %>
    <p class="text-muted mb-3">
      <strong><%= @merch.count %></strong> r√©sultat(s) trouv√©(s)
    </p>
  <% end %>

  <% if @merch.any? %>
    <div class="row g-4">

      <% @merch.each do |m| %>
        <div class="col-md-6 col-lg-4">
          <div class="card shadow-sm rounded-4 p-3 h-100">

            <h5 class="fw-bold text-orange mb-1">
              <%= m.displayable_name(current_user) %>
            </h5>

            <% if m.merch_setting.present? %>
              <p class="small mb-1 text-muted">
                <i class="bi bi-briefcase-fill"></i> Missions :
                <strong><%= m.merch_setting.mission_preferences %></strong>
              </p>
            <% end %>

            <p class="text-muted mb-2">
              <strong>Ville :</strong>
              <%= m.city.presence || "‚Äî" %>
              <br>
              <strong>Code postal :</strong>
              <%= m.zipcode.presence || "‚Äî" %>
            </p>

            <%# Correction de l'association pour utiliser fve_contracts et l'ID du FVE %>
            <% if m.fve_contracts.where(fve_id: current_user.id).exists? %>
              <p class="mb-2">
                <span class="badge bg-success rounded-pill">‚úì Contrat existant avec votre FVE</span>
              </p>
            <% end %>

            <div class="mb-2 small">
              <strong>‚úâÔ∏è Email :</strong>
              <%= m.displayable_email(current_user) || "<span class='text-muted'>Non visible</span>".html_safe %>
              <br>
              <strong>üìû T√©l√©phone :</strong>
              <%= m.displayable_phone(current_user) || "<span class='text-muted'>Non visible</span>".html_safe %>
            </div>

            <% if params[:start_date].present? || params[:end_date].present? %>
              <% unavailable_dates = m.unavailabilities.pluck(:date) %>
              <% if unavailable_dates.empty? %>
                <p class="text-success small mb-2">‚úì Disponible sur la p√©riode</p>
              <% end %>
            <% end %>

            <div class="mt-auto d-grid">
              <%= link_to "Voir le profil d√©taill√©",
                    fve_merch_path(m),
                    class: "btn btn-orange fw-semibold btn-sm" %>
            </div>

          </div>
        </div>
      <% end %>

    </div>

  <% else %>
    <div class="text-center mt-5">
      <p class="text-muted">
        <%= has_search || params[:query].present? ?
            "üîç Aucun merchandiser ne correspond √† vos crit√®res." :
            "üìã Utilisez les filtres ci-dessus pour rechercher des merchandisers." %>
      </p>
    </div>
  <% end %>

</div>
