<%# app/views/proposals/index.html.erb %>

<div class="container mt-4 mb-5">
  <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
    <h1 class="fw-bold text-orange">
      <i class="fa-solid fa-briefcase me-2"></i> Opportunités (<%= @proposals.count %>)
    </h1>
    <%= link_to 'Retour au Tableau de bord', dashboard_path, class: 'btn btn-orange-outline fw-semibold' %>
  </div>

  <% if @proposals.any? %>
    <div class="row g-4">
      <% @proposals.each do |proposal| %>
        <div class="col-md-6">

          <div class="card shadow-sm p-3 rounded-4 h-100 border border-secondary-subtle">
            <div class="card-body">

              <%# TITRE / AGENCE / DATE PROPOSÉE %>
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title fw-bold text-dark mb-0">
                  <span class="text-orange me-1"><%= proposal.fve.agency_label %></span>
                </h5>
                <small class="text-muted text-end fst-italic">
                  Proposé le <%= l proposal.created_at.to_date, format: :default %> à <%= l proposal.created_at, format: :short_time %>
                </small>
              </div>

              <hr class="mt-0 mb-3">

              <div class="row small g-2">
                <%# Date de la mission %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-calendar-day me-1"></i> Date :</strong>
                  <span class="fw-semibold"><%= l proposal.date, format: :long %></span>
                </div>

                <%# Heures de la mission %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-clock me-1"></i> Heures :</strong>
                  <%= proposal.start_time.strftime('%H:%M') %> – <%= proposal.end_time.strftime('%H:%M') %>
                </div>

                <%# Magasin %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-shop me-1"></i> Magasin :</strong>
                  <%= proposal.store_name %>
                </div>

                <%# Lieu synthétique %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-map-marker-alt me-1"></i> Ville :</strong>
                  <%= proposal.store_address.split(',').last.to_s.strip %>
                </div>
              </div>

              <%# TAUX PROPOSÉ (MIS EN ÉVIDENCE) %>
              <div class="mt-3 p-2 text-center border-top border-bottom">
                <span class="text-dark fw-bold me-2">Taux Horaire Proposé :</span>
                <span class="text-orange fw-bolder fs-5">
                  <%= number_to_currency(proposal.hourly_rate) %>/h
                </span>
              </div>

              <%# MESSAGE (Optionnel) %>
              <% if proposal.message.present? %>
                <div class="alert alert-light border-start border-3 border-secondary-subtle mt-3 mb-0 py-2 px-3 small fst-italic text-dark">
                  **Message de l'Agence :** "<%= proposal.message %>"
                </div>
              <% end %>

              <hr class="mb-3">

              <%# BOUTONS D'ACTION DÉFINITIFS %>
              <div class="d-flex justify-content-end">

                <%# Bouton Accepter %>
                <%= button_to 'Accepter',
                      merch_proposal_path(proposal, mission_proposal: { status: :accepted }),
                      method: :patch,
                      data: { turbo_confirm: "Confirmez-vous l'acceptation de cette mission ?" },
                      class: 'btn btn-green me-2' %>

                <%# Bouton Refuser %>
                <%= button_to 'Refuser',
                      merch_proposal_path(proposal, mission_proposal: { status: :declined }),
                      method: :patch,
                      data: { turbo_confirm: "Confirmez-vous le refus de cette proposition ?" },
                      class: 'btn btn-red' %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-success mt-4 rounded-4" role="alert">
      <h4 class="alert-heading"><i class="fa-solid fa-face-smile me-2"></i> C'est calme pour le moment !</h4>
      <p class="mb-0">
        Vous n'avez actuellement aucune nouvelle proposition de mission en attente. Revenez plus tard.
      </p>
    </div>
  <% end %>

</div>
