<%# app/views/proposals/index.html.erb %>

<div class="container mt-4 mb-5">

  <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
    <h1 class="fw-bold text-orange">
      <i class="fa-solid fa-briefcase me-2"></i> Opportunités
    </h1>
    <%= link_to 'Retour au Tableau de bord', dashboard_path, class: 'btn btn-orange-outline fw-semibold' %>
  </div>

  <%# ========================================================== %>
  <%# NAVIGATION MOIS ET FILTRE STATUT %>
  <%# ========================================================== %>
  <div class="row mb-4 align-items-center">

    <%# Bloc 1 : Navigation Mensuelle %>
    <div class="col-md-6 d-flex justify-content-start align-items-center mb-3 mb-md-0">

      <%# Bouton Précédent %>
      <%= link_to merch_proposals_path(year: @prev_year, month: @prev_month, status: @status_filter),
                  class: "btn btn-orange-outline me-3 rounded-3" do %>
        <i class="fa-solid fa-chevron-left"></i>
      <% end %>

      <h4 class="fw-semibold m-0 text-capitalize">
        <%= I18n.l @target_date, format: "%B %Y" %>
      </h4>

      <%# Bouton Suivant (Désactivé si futur) %>
      <% is_next_month_in_future = (@target_date + 1.month).beginning_of_month > Date.current.beginning_of_month %>
      <%= link_to merch_proposals_path(year: @next_year, month: @next_month, status: @status_filter),
                  class: "btn btn-orange-outline ms-3 rounded-3 #{'disabled' if is_next_month_in_future}" do %>
        <i class="fa-solid fa-chevron-right"></i>
      <% end %>
    </div>

    <%# Bloc 2 : Filtre par Statut %>
    <div class="col-md-6 text-end">
      <%# Filtre "Tous" (si aucun statut sélectionné) %>
      <%= link_to "Tous",
            merch_proposals_path(year: @year, month: @month, status: nil),
            class: "btn btn-sm #{!@status_filter.present? ? 'btn-orange' : 'btn-outline-secondary'} fw-semibold me-2" %>

      <%# Filtres par statut (Pending, Accepted, Declined) %>
      <% MissionProposal.statuses.keys.each do |status| %>
        <%= link_to status.humanize.capitalize,
              merch_proposals_path(year: @year, month: @month, status: status),
              class: "btn btn-sm #{status == @status_filter ? 'btn-orange' : 'btn-outline-secondary'} me-2 fw-semibold" %>
      <% end %>
    </div>
  </div>


  <%# ========================================================== %>
  <%# LISTE DES PROPOSITIONS %>
  <%# ========================================================== %>

  <% if @proposals.any? %>
    <div class="row g-4 mt-3">
      <% @proposals.each do |proposal| %>
        <div class="col-md-6">

          <div class="card shadow-sm p-3 rounded-4 h-100
            <%= proposal.pending? ? 'border-warning' : (proposal.accepted? ? 'border-success' : 'border-danger') %>">
            <div class="card-body">

              <%# TITRE / AGENCE / DATE PROPOSÉE %>
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title fw-bold text-dark mb-0">
                  <span class="text-orange me-1"><%= proposal.fve.agency_label %> - <%= proposal.company %></span>
                </h5>
                <small class="text-muted text-end fst-italic">
                  Proposé le <%= l proposal.created_at.to_date, format: :default %> à <%= l proposal.created_at, format: :short_time %>
                </small>
              </div>

              <hr class="mt-0 mb-3">

              <div class="row small g-2">
                <%# Date de la mission %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-calendar-day me-1"></i> Date :</strong>
                  <span class="fw-semibold"><%= l proposal.date, format: :long %></span>
                </div>

                <%# Heures de la mission %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-clock me-1"></i> Heures :</strong>
                  <%= proposal.start_time.strftime('%H:%M') %> – <%= proposal.end_time.strftime('%H:%M') %>
                </div>

                <%# Magasin %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-shop me-1"></i> Magasin :</strong>
                  <%= proposal.store_name %>
                </div>

                <%# Lieu synthétique %>
                <div class="col-12 col-md-6">
                  <strong><i class="fa-solid fa-map-marker-alt me-1"></i> Adresse :</strong>
                  <%= proposal.store_address %>
                </div>
              </div>

              <%# TAUX PROPOSÉ %>
              <div class="mt-3 p-2 text-center border-top border-bottom">
                <span class="text-dark fw-bold me-2">Taux Horaire Proposé :</span>
                <span class="text-orange fw-bolder fs-5">
                  <%= number_to_currency(proposal.hourly_rate) %>/h
                </span>
              </div>

              <%# MESSAGE (Optionnel) %>
              <% if proposal.message.present? %>
                <div class="alert alert-light border-start border-3 border-secondary-subtle mt-3 mb-0 py-2 px-3 small fst-italic text-dark">
                  **Message de l'Agence :** "<%= proposal.message %>"
                </div>
              <% end %>

              <hr class="mb-3">

              <%# BOUTONS D'ACTION (Affichés seulement si la proposition est en attente) %>
              <div class="d-flex justify-content-end">
                <% if proposal.pending? %>
                  <%= button_to 'Accepter',
                        merch_proposal_path(proposal, mission_proposal: { status: 'accepted' }),
                        method: :patch,
                        data: { turbo_confirm: "Confirmez-vous l'acceptation de cette mission ?" },
                        class: 'btn btn-green me-2' %>

                  <%= button_to 'Refuser',
                        merch_proposal_path(proposal, mission_proposal: { status: 'declined' }),
                        method: :patch,
                        data: { turbo_confirm: "Confirmez-vous le refus de cette proposition ?" },
                        class: 'btn btn-red' %>
                <% else %>
                  <span class="badge <%= proposal.accepted? ? 'bg-success' : 'bg-danger' %> fw-bold py-2 px-3">
                    <%= proposal.status.humanize %> - Mission <%= proposal.accepted? ? 'Validée' : 'Rejetée' %>
                  </span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-info mt-4 rounded-4" role="alert">
      <h4 class="alert-heading"><i class="fa-solid fa-info-circle me-2"></i> Historique vide !</h4>
      <p class="mb-0">
        Aucune proposition <%= @status_filter.present? ? @status_filter.humanize : 'pour ce mois' %> n'a été trouvée.
      </p>
    </div>
  <% end %>

</div>
