<div class="container my-5">

  <h1 class="fw-bold text-orange mb-4">Déclaration France Travail</h1>

  <div class="card shadow-sm rounded-4 p-3 mb-4">
    <%= form_with url: france_travail_path, method: :get, local: true, class: "row g-3 align-items-end" do %>

      <div class="col-8">
        <label class="fw-semibold mb-1">Rechercher un mois</label>
        <%= month_field_tag :date,
              "#{@year}-#{sprintf('%02d', @month)}",
              class: "form-control" %>
      </div>

      <div class="col-4">
        <button class="btn btn-orange w-100 fw-semibold">
          Rechercher
        </button>
      </div>

    <% end %>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to france_travail_path(year: @year, month: @month - 1),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-semibold text-capitalize m-0">
      <%= I18n.l Date.new(@year, @month), format: "%B %Y" %>
    </h3>

    <%= link_to france_travail_path(year: @year, month: @month + 1),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>
  </div>

  <% if @grouped.empty? %>
    <p class="text-muted text-center mt-5">
      Aucune mission pour ce mois.
    </p>
  <% end %>

  <% @grouped.each do |agency, sessions| %>

    <%
       # CALCULS PRÉCIS VIA LE MODÈLE (SANS IFM)

       # 1. Heures
       total_minutes = sessions.sum(&:duration_minutes)
       hours = (total_minutes / 60.0).round(2)

       # 2. Brut de Base (Salaire brut hors primes)
       base_brut = sessions.sum(&:brut)

       # 3. CP (Congés Payés) - Toujours calculés par le modèle
       total_cp = sessions.sum(&:amount_cp)

       # 4. Total à Déclarer (UNIQUEMENT Base + CP)
       # L'IFM est exclue ici comme demandé
       declare = base_brut + total_cp
    %>

    <div class="card shadow-sm rounded-4 p-4 mb-4 bg-white">

      <h4 class="fw-bold text-orange mb-3"><%= agency.upcase %></h4>

      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <p class="text-muted m-0">Heures effectuées</p>
        <h4 class="fw-bold m-0"><%= hours %> h</h4>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-12 d-flex justify-content-between">
          <span class="text-muted small">Salaire Brut (Base)</span>
          <span class="fw-bold small"><%= number_to_currency(base_brut) %></span>
        </div>

        <div class="col-12 d-flex justify-content-between">
          <span class="text-muted small">Congés Payés (CP)</span>
          <span class="fw-bold small"><%= number_to_currency(total_cp) %></span>
        </div>
      </div>

      <div class="bg-light p-3 rounded-3 mt-2 text-center">
        <p class="text-muted m-0 small mb-1">Montant Brut à déclarer (Base + CP)</p>
        <h3 class="fw-bold text-orange m-0">
          <%= number_to_currency(declare) %>
        </h3>
        <small class="text-muted" style="font-size: 0.7rem;">(Hors IFM)</small>
      </div>

    </div>
  <% end %>

</div>
