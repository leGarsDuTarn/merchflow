<div class="container my-5" data-controller="day unavailability">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-dark m-0">Planning du mois</h1>
  </div>

  <!-- Navigation mois -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to planning_path(year: @prev_year, month: @prev_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-semibold m-0 text-capitalize">
      <%= I18n.l(Date.new(@year, @month), format: "%B %Y") %>
    </h3>

    <%= link_to planning_path(year: @next_year, month: @next_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>
  </div>

  <!-- Mobile hint -->
  <div class="d-lg-none text-center mb-3">
    <div class="d-inline-block bg-light px-3 py-1 rounded-pill border">
      <small class="text-muted">Vue simplifiée : jours libres masqués.</small>
    </div>
  </div>

  <!-- Headers desktop -->
  <div class="d-none d-lg-block shadow-sm rounded-4 p-3 mb-2 bg-white">
    <div class="week-headers">
      <div>Lun</div><div>Mar</div><div>Mer</div>
      <div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
  </div>

  <!-- CALENDRIER -->
  <div class="calendar-wrapper">

    <!-- Point d'ancrage pour auto-scroll vers aujourd'hui (mobile) -->
    <div id="today-anchor" class="d-lg-none" data-day-target="todayAnchor"></div>

    <div class="calendar-grid shadow-sm rounded-4 p-3">

      <% @weeks.each do |week| %>
        <div class="calendar-row">

          <% week.each do |day| %>
            <% sessions = (@sessions_by_date[day] || []).sort_by(&:start_time) %>
            <% unav = @unavailabilities.find { |u| u.date == day } %>
            <% is_today = (day == Date.today) %>

            <div class="calendar-cell rounded-3 position-relative
                        <%= 'today' if is_today %>
                        <%= sessions.any? ? 'cell-busy' : 'cell-available' %>
                        <%= 'cell-unavailable' if unav.present? %>"

                 data-action="click->day#open"
                 data-date="<%= day %>"
                 data-has-missions="<%= sessions.any? %>"
                 data-has-unavailability="<%= unav.present? %>"
                 data-unavailability-id="<%= unav&.id %>"
                 data-unavailability-notes="<%= unav&.notes %>"
                 data-missions="<%= sessions.map { |ws|
                       { id: ws.id, company: ws.company, start: ws.start_time.strftime("%H:%M"), end: ws.end_time.strftime("%H:%M") }
                     }.to_json %>">

              <!-- Header date + icône -->
              <div class="d-flex justify-content-between align-items-start p-1">
                <div class="date-number fw-semibold <%= 'text-orange' if day.month == @month %>">
                  <%= day.day %>
                </div>

                <% if unav.present? %>
                  <i class="fa-solid fa-pen text-orange small"></i>
                <% elsif sessions.any? %>
                  <i class="fa-solid fa-pen text-orange small"></i>
                <% else %>
                  <i class="fa-solid fa-plus text-muted opacity-25 small add-icon"></i>
                <% end %>
              </div>

              <!-- Indisponibilité -->
              <% if unav.present? %>
                <div class="p-1 small">
                  <div class="text-danger fw-bold">Indisponible</div>

                  <% if unav.notes.present? %>
                    <div class="text-muted small mt-1">
                      <span class="fw-semibold">Motif:</span>
                      <%= unav.notes %>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- Missions -->
              <div class="sessions-container mt-2">
                <% sessions.first(3).each do |ws| %>
                  <div class="session-item position-relative">
                    <div class="d-flex flex-column">
                      <span class="fw-bold text-dark text-truncate"><%= ws.store %> - <%= ws.company %></span>
                      <span class="text-muted small">
                        <%= ws.start_time.strftime("%H:%M") %> - <%= ws.end_time.strftime("%H:%M") %>
                      </span>
                    </div>
                  </div>
                <% end %>
              </div>

            </div>
          <% end %>

        </div>
      <% end %>

    </div>
  </div>

  <!-- ========================================================= -->
  <!-- =============== MODALE ACTIONS DU JOUR ================== -->
  <!-- ========================================================= -->

  <div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true" data-controller="unavailability day">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow">

        <div class="modal-header">
          <h5 class="modal-title fw-bold text-orange" id="dayModalTitle">Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" id="dayModalBody">
          <!-- Rempli par Stimulus -->
        </div>

        <div class="modal-footer" id="dayModalFooter">
          <!-- Rempli par Stimulus -->
        </div>

      </div>
    </div>
  </div>

  <!-- ========================================================= -->
  <!-- ============ BARRE D’ACTIONS MOBILE FIXE ================= -->
  <!-- ========================================================= -->
  <div class="mobile-action-bar d-lg-none">
    <button
      class="btn btn-orange w-100 mb-2"
      data-action="day#openNewMission">
      <i class="fa-solid fa-briefcase me-2"></i>
      Ajouter une mission
    </button>

    <button
      class="btn btn-orange-outline w-100"
      data-action="day#openNewUnavailability">
      <i class="fa-solid fa-ban me-2"></i>
      Ajouter une indisponibilité
    </button>
  </div>

</div>
