<div class="container my-5">

  <!-- Titre -->
  <h1 class="fw-bold text-orange mb-4">Planning du mois</h1>

  <!-- Navigation mois -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to planning_path(year: @prev_year, month: @prev_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-semibold m-0 text-capitalize">
      <%= I18n.l Date.new(@year, @month), format: "%B %Y" %>
    </h3>

    <%= link_to planning_path(year: @next_year, month: @next_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>
  </div>

  <!-- Message mobile -->
  <div class="d-lg-none text-center mb-3 animate__animated animate__fadeIn">
    <div class="d-inline-block bg-light px-3 py-1 rounded-pill border">
        <small class="text-muted">
          Vue simplifiée : les jours libres sont masqués.
        </small>
    </div>
  </div>

  <!-- Calendrier -->
  <div class="calendar-grid shadow-sm rounded-4 p-3">
    <% @weeks.each do |week| %>

      <div class="calendar-row">

        <% week.each do |day| %>
          <%
             raw_sessions = @sessions_by_date[day] || []
             sessions = raw_sessions.sort_by(&:start_time)
          %>

          <div class="calendar-cell p-2 rounded-3 position-relative
                      <%= 'today' if day == Date.today %>
                      <%= sessions.any? ? 'cell-busy' : 'cell-available' %>">

            <%= link_to "", new_work_session_path(date: day),
                class: "stretched-link",
                aria: { label: "Ajouter une mission le #{day}" } %>

            <div class="d-flex justify-content-between align-items-start">
              <div class="date-number fw-semibold <%= 'text-orange' if day.month == @month %>">
                <%= day.day %>
              </div>
              <i class="fa-solid fa-plus text-muted opacity-25 small add-icon"></i>
            </div>

            <div class="sessions-container">
  <% sessions.each do |ws| %>

    <%= link_to work_session_path(ws),
        class: "session-item text-decoration-none position-relative",
        style: "z-index: 2;" do %>

      <div class="d-flex flex-column justify-content-center">
        <span class="fw-bold text-dark text-truncate" style="line-height: 1.1;">
          <%= ws.contract.agency %>
        </span>

        <span class="text-muted small">
          <%= ws.start_time.strftime("%H:%M") %>-<%= ws.end_time.strftime("%H:%M") %>
        </span>
      </div>

    <% end %>

  <% end %>
</div>

          </div>
        <% end %>

      </div>

    <% end %>
  </div>

  <!-- Liste détaillée -->
  <hr class="my-5">

  <h2 class="fw-bold text-orange mb-3">Vos missions du mois</h2>

  <div class="list-group shadow-sm rounded-4">
    <% @sessions.order(:date, :start_time).each do |ws| %>
      <div class="list-group-item p-3">

        <div class="d-flex justify-content-between align-items-center">

          <div>
            <h5 class="fw-semibold m-0">
              <%= l ws.date, format: :long %>
            </h5>

            <p class="text-muted m-0">
              <%= ws.contract.agency %> •
              <%= ws.start_time.strftime("%H:%M") %> –
              <%= ws.end_time.strftime("%H:%M") %>
            </p>
          </div>

          <%= link_to "Voir",
                      work_session_path(ws),
                      class: "btn btn-orange-outline btn-sm rounded-3" %>
        </div>

      </div>
    <% end %>
  </div>

</div>
