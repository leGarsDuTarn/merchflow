<div class="container my-5">

  <!-- Titre -->
  <h1 class="fw-bold text-orange mb-4">Planning du mois</h1>

  <!-- Navigation mois -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to planning_path(year: @prev_year, month: @prev_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <h3 class="fw-semibold m-0 text-capitalize">
      <%= I18n.l Date.new(@year, @month), format: "%B %Y" %>
    </h3>

    <%= link_to planning_path(year: @next_year, month: @next_month),
                class: "btn btn-orange-outline rounded-3" do %>
      <i class="fa-solid fa-chevron-right"></i>
    <% end %>
  </div>


  <!-- Message mobile -->
  <div class="d-lg-none text-center mb-3 animate__animated animate__fadeIn">
    <div class="d-inline-block bg-light px-3 py-1 rounded-pill border">
        <small class="text-muted">
          Vue simplifiée : les jours libres sont masqués.
        </small>
    </div>
  </div>


 <!-- Jours de la semaine (DESKTOP) -->
<div class="d-none d-lg-block shadow-sm rounded-4 p-3 mb-2 bg-white">
  <div class="week-headers">
    <div>Lun</div>
    <div>Mar</div>
    <div>Mer</div>
    <div>Jeu</div>
    <div>Ven</div>
    <div>Sam</div>
    <div>Dim</div>
  </div>
</div>



  <!-- CALENDRIER (scrollable seulement en mobile) -->
<div class="calendar-wrapper">

  <div class="calendar-grid shadow-sm rounded-4 p-3">

    <% @weeks.each do |week| %>

      <div class="calendar-row">
        <% week.each do |day| %>
          <% raw_sessions = @sessions_by_date[day] || [] %>
          <% sessions     = raw_sessions.sort_by(&:start_time) %>

          <!-- AJOUT : détecter indisponibilité -->
          <% is_unavailable = @unavailable_dates&.include?(day) %>

          <div class="calendar-cell rounded-3 position-relative
                      <%= 'today' if day == Date.today %>
                      <%= sessions.any? ? 'cell-busy' : 'cell-available' %>
                      <%= 'cell-unavailable' if is_unavailable %>"> <!-- AJOUT -->

            <!-- Lien "+ Ajouter mission" (désactivé si indispo) -->
            <% unless is_unavailable %> <!-- AJOUT -->
              <%= link_to "", new_work_session_path(date: day),
                  class: "stretched-link",
                  aria: { label: "Ajouter une mission le #{day}" } %>
            <% end %> <!-- AJOUT -->

            <!-- Header de la case -->
            <div class="d-flex justify-content-between align-items-start p-1">
              <div class="date-number fw-semibold <%= 'text-orange' if day.month == @month %>">
                <%= day.day %>
              </div>
              <% unless is_unavailable %> <!-- AJOUT -->
                <i class="fa-solid fa-plus text-muted opacity-25 small add-icon"></i>
              <% end %> <!-- AJOUT -->
            </div>

            <!-- AJOUT : Bouton Indispo / Disponible -->
            <div class="p-1">
              <% if is_unavailable %>
                <% unav = @unavailabilities.find { |u| u.date == day } %>

                <%= button_to unavailability_path(unav),
                      method: :delete,
                      class: "btn btn-success btn-sm w-100 mt-1",
                      form: { style: "z-index:10; position:relative;" } do %>
                  Disponible
                <% end %>

              <% else %>

                <%= button_to unavailabilities_path(unavailability: { date: day }),
                      method: :post,
                      class: "btn btn-warning btn-sm w-100 mt-1",
                      form: { style: "z-index:10; position:relative;" } do %>
                  Indisponible
                <% end %>

              <% end %>
            </div>
            <!-- FIN AJOUT -->

            <!-- Liste des missions du jour -->
            <div class="sessions-container">
              <% sessions.each do |ws| %>

                <%= link_to work_session_path(ws),
                    class: "session-item text-decoration-none position-relative",
                    style: "z-index: 2;" do %>

                  <div class="d-flex flex-column justify-content-center">
                    <span class="fw-bold text-dark text-truncate" style="line-height: 1.1;">
                      <%= ws.contract.agency %>
                    </span>

                    <span class="text-muted small">
                      <%= ws.start_time.strftime("%H:%M") %> - <%= ws.end_time.strftime("%H:%M") %>
                    </span>
                  </div>

                <% end %>

              <% end %>
            </div>

          </div>
        <% end %>
      </div>

    <% end %>

  </div>
</div>



  <!-- BOUTON MOBILE FLOTTANT -->
  <div class="add-mission-mobile d-lg-none">
    <%= link_to new_work_session_path,
        class: "btn btn-orange fw-semibold d-flex align-items-center justify-content-center" do %>
      <i class="fa-solid fa-plus me-2"></i>
      Ajouter une mission
    <% end %>
  </div>

</div>
